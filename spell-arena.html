<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ìŠ¤í  ì•„ë ˆë‚˜</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  background:#0a0a12;
  font-family:'Segoe UI',sans-serif;
  overflow:hidden; touch-action:none;
  display:flex; align-items:center; justify-content:center;
  height:100vh; width:100vw;
}

/* â”€â”€ SCREENS â”€â”€ */
.screen { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.screen.hidden { display:none !important; }

/* â”€â”€ MENU â”€â”€ */
#menuScreen {
  background:radial-gradient(ellipse at 50% 40%,#1e1040 0%,#0a0a12 70%);
  color:white; gap:12px; text-align:center; padding:20px; overflow-y:auto;
}
#menuScreen h1 {
  font-size:clamp(24px,5.5vw,48px);
  background:linear-gradient(90deg,#a855f7,#ec4899,#f59e0b);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 16px #a855f7aa);
}
.tagline { color:#c4b5fd; font-size:clamp(11px,1.8vw,15px); font-style:italic; }
.vs-row  { font-size:clamp(36px,7vw,60px); }
.mode-tabs { display:flex; gap:10px; }
.tab-btn {
  flex:1; padding:10px 20px; font-size:clamp(13px,2vw,16px); font-weight:700;
  border:2px solid rgba(168,85,247,.4); border-radius:12px;
  background:transparent; color:#c4b5fd; cursor:pointer; transition:all .2s;
}
.tab-btn.active { background:linear-gradient(135deg,#7c3aed,#ec4899); border-color:transparent; color:white; }
.tab-content { display:none; width:100%; max-width:500px; }
.tab-content.active { display:flex; flex-direction:column; gap:10px; align-items:center; }

/* Multiplayer panel */
.mp-panel {
  background:rgba(168,85,247,.1); border:1px solid rgba(168,85,247,.3);
  border-radius:14px; padding:16px; width:100%; text-align:left;
}
.mp-panel h3 { color:#a855f7; margin-bottom:10px; font-size:14px; }
.mp-input {
  width:100%; padding:10px 14px; border-radius:10px;
  background:rgba(255,255,255,.08); border:1.5px solid rgba(168,85,247,.4);
  color:white; font-size:15px; outline:none; margin-bottom:8px;
  font-family:'Segoe UI',sans-serif;
}
.mp-input:focus { border-color:#a855f7; }
.room-code {
  font-size:28px; font-weight:900; letter-spacing:4px;
  color:#f59e0b; text-align:center; padding:8px;
  background:rgba(245,158,11,.1); border-radius:8px;
  border:1.5px solid rgba(245,158,11,.3);
}
.status-text { font-size:12px; color:#94a3b8; text-align:center; min-height:16px; }
.status-text.ok  { color:#34d399; }
.status-text.err { color:#f87171; }

/* info grid */
.info-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px;
  max-width:min(500px,92vw); font-size:clamp(10px,1.6vw,12px);
}
.info-card {
  background:rgba(168,85,247,.08); border:1px solid rgba(168,85,247,.25);
  border-radius:10px; padding:10px; text-align:left;
}
.info-card h3 { color:#a855f7; margin-bottom:5px; font-size:1em; }
.info-card p  { color:#e0e7ff; margin:2px 0; }

/* â”€â”€ BUTTONS â”€â”€ */
.primary-btn {
  padding:10px 32px; font-size:clamp(13px,2.2vw,17px); font-weight:700;
  background:linear-gradient(135deg,#a855f7,#ec4899);
  color:white; border:none; border-radius:30px; cursor:pointer;
  box-shadow:0 5px 20px #a855f760; transition:transform .15s,box-shadow .15s; width:100%;
}
.primary-btn:hover { transform:translateY(-2px); box-shadow:0 8px 28px #a855f790; }
.primary-btn:disabled { opacity:.4; cursor:not-allowed; transform:none; }
.primary-btn.ghost { background:linear-gradient(135deg,#374151,#4b5563); }
.primary-btn.orange{ background:linear-gradient(135deg,#d97706,#f59e0b); }

/* â”€â”€ GAME SCREEN â”€â”€ */
#gameScreen { flex-direction:row; align-items:stretch; background:#0a0a12; }
.side-panel {
  width:clamp(78px,11vw,130px);
  background:rgba(15,14,30,.92); flex-shrink:0;
  display:flex; flex-direction:column; gap:5px; padding:6px 5px;
  border-right:1px solid rgba(168,85,247,.18);
}
.side-panel.right { border-right:none; border-left:1px solid rgba(168,85,247,.18); }
.panel-title { font-size:9px; color:#a855f7; font-weight:700; text-align:center; margin-bottom:2px; }
.action-btn {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:1px; padding:7px 4px; border:none; border-radius:10px; cursor:pointer;
  font-size:20px; position:relative; overflow:hidden;
  transition:transform .1s,opacity .2s; box-shadow:0 3px 8px #0005;
}
.action-btn:active { transform:scale(.9); }
.action-btn.spell    { background:linear-gradient(135deg,#7c3aed,#ec4899); }
.action-btn.creature { background:linear-gradient(135deg,#059669,#0891b2); }
.action-btn:disabled { opacity:.3; cursor:not-allowed; }
.action-btn .key  { position:absolute; top:2px; right:4px; font-size:7px; color:rgba(255,255,255,.5); font-weight:700; }
.action-btn .cost { font-size:8px; color:rgba(255,255,255,.8); }
.cd-mask {
  position:absolute; inset:0; background:rgba(0,0,0,.6);
  display:flex; align-items:center; justify-content:center;
  font-size:10px; color:#fff; font-weight:700; border-radius:10px;
}

#center-col { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }

/* â”€â”€ HUD â”€â”€ */
#hud {
  display:flex; align-items:center; justify-content:space-between;
  padding:5px 8px; gap:5px; flex-shrink:0;
  background:rgba(10,10,20,.88); border-bottom:1px solid rgba(168,85,247,.18);
}
.hud-side { display:flex; align-items:center; gap:6px; flex:1; min-width:0; }
.hud-side.right { flex-direction:row-reverse; }
.hud-avatar { font-size:20px; flex-shrink:0; }
.hud-bars { display:flex; flex-direction:column; gap:3px; flex:1; min-width:0; }
.hud-bar-row { display:flex; align-items:center; gap:3px; font-size:9px; color:#e2e8f0; }
.hud-track { flex:1; height:5px; background:rgba(255,255,255,.12); border-radius:3px; overflow:hidden; min-width:24px; }
.hud-fill { height:100%; border-radius:3px; transition:width .2s; }
.hud-fill.hp  { background:linear-gradient(90deg,#10b981,#34d399); }
.hud-fill.hp.low { background:linear-gradient(90deg,#ef4444,#f87171); }
.hud-fill.hp.e{ background:linear-gradient(90deg,#ef4444,#f87171); }
.hud-fill.mp  { background:linear-gradient(90deg,#6366f1,#a855f7); }
.hud-val { font-size:9px; font-weight:700; min-width:16px; }
#hud-mid { display:flex; flex-direction:column; align-items:center; gap:1px; flex-shrink:0; }
#round-info { font-size:8px; color:#c4b5fd; font-weight:700; letter-spacing:.5px; }
#timer { font-size:16px; color:#a855f7; font-weight:800; line-height:1; }
.pips { display:flex; gap:3px; }
.pip { width:8px; height:8px; border-radius:50%; border:1.5px solid #4b5563; background:transparent; transition:all .3s; }
.pip.p { background:#3b82f6; border-color:#3b82f6; }
.pip.e { background:#ef4444; border-color:#ef4444; }

/* â”€â”€ CANVAS â”€â”€ */
#canvas-wrap { flex:1; position:relative; overflow:hidden; min-height:0; background:#0a0a12; }
#gameCanvas  { display:block; touch-action:none; position:absolute; }

/* â”€â”€ OVERLAY â”€â”€ */
#overlayScreen {
  background:rgba(5,5,15,.9); z-index:50; gap:12px;
  color:white; text-align:center; padding:20px;
}
#overlayScreen h2 { font-size:clamp(22px,5vw,42px); }
#overlayScreen p  { color:#c4b5fd; font-size:clamp(11px,2vw,15px); }
.overlay-btns { display:flex; gap:10px; justify-content:center; margin-top:6px; }

/* â”€â”€ MOBILE D-PAD â”€â”€ */
#dpad {
  position:absolute; bottom:10px; left:10px;
  width:130px; height:130px;
  display:none; z-index:40; touch-action:none;
}
.dpad-btn {
  position:absolute; width:40px; height:40px;
  background:rgba(168,85,247,.25); border:2px solid rgba(168,85,247,.5);
  border-radius:10px; display:flex; align-items:center; justify-content:center;
  font-size:18px; color:white; cursor:pointer; user-select:none;
  transition:background .1s;
}
.dpad-btn:active, .dpad-btn.pressed { background:rgba(168,85,247,.6); }
#dpad-up    { top:0;   left:45px; }
#dpad-down  { bottom:0;left:45px; }
#dpad-left  { left:0;  top:45px; }
#dpad-right { right:0; top:45px; }
#dpad-center{ left:45px; top:45px; width:40px; height:40px;
  background:rgba(168,85,247,.1); border:1.5px solid rgba(168,85,247,.2); border-radius:50%; }

/* â”€â”€ MOBILE SHOOT â”€â”€ */
#shoot-btn {
  position:absolute; bottom:10px; right:10px;
  width:60px; height:60px; border-radius:50%;
  background:linear-gradient(135deg,#dc2626,#f97316);
  border:3px solid rgba(255,255,255,.4);
  font-size:24px; display:none; align-items:center; justify-content:center;
  cursor:pointer; z-index:40; touch-action:none;
  box-shadow:0 4px 14px #dc262660;
}

/* mobile: show dpad */
@media (max-width:700px) {
  .side-panel { width:68px; }
  .action-btn { font-size:17px; padding:6px 2px; }
  #dpad, #shoot-btn { display:flex; }
}

/* â”€â”€ CONNECTING â”€â”€ */
#connectingScreen {
  background:rgba(5,5,15,.95); z-index:80; gap:16px; color:white; text-align:center;
}
#connectingScreen h2 { font-size:clamp(20px,4vw,36px); color:#a855f7; }
.spinner {
  width:50px; height:50px; border:4px solid rgba(168,85,247,.3);
  border-top-color:#a855f7; border-radius:50%; animation:spin .8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }
</style>
</head>
<body>

<!-- â•â• MENU â•â• -->
<div id="menuScreen" class="screen">
  <h1>âš”ï¸ SPELL ARENA âš”ï¸</h1>
  <p class="tagline">ë§ˆë‚˜ëŠ” ë°”ë‹¥ì— ìˆê³ , ê·¸ê±¸ ë¨¹ìœ¼ëŸ¬ ê°€ëŠ” ìˆœê°„ ì•½ì ì´ ëœë‹¤</p>
  <div class="vs-row">ğŸ§™â€â™‚ï¸ VS ğŸ§™â€â™€ï¸</div>

  <div class="mode-tabs">
    <button class="tab-btn active" onclick="switchTab('solo')">ğŸ¤– ì†”ë¡œ í”Œë ˆì´</button>
    <button class="tab-btn"       onclick="switchTab('multi')">ğŸŒ ë©€í‹°í”Œë ˆì´</button>
  </div>

  <!-- SOLO TAB -->
  <div id="tab-solo" class="tab-content active">
    <button class="primary-btn" id="startSoloBtn">âš¡ ê²Œì„ ì‹œì‘ (vs AI)</button>
    <div class="info-grid">
      <div class="info-card">
        <h3>ğŸ® ì¡°ì‘</h3>
        <p>WASD / ë°©í–¥í‚¤: ì´ë™</p>
        <p>Space: ê¸°ë³¸ ê³µê²©</p>
        <p>1~4: ìŠ¤í  / Q~R: í¬ë¦¬ì²˜</p>
        <p>ëª¨ë°”ì¼: DíŒ¨ë“œ + ë²„íŠ¼</p>
      </div>
      <div class="info-card">
        <h3>ğŸ’ ë§ˆë‚˜ ì˜¤ë¸Œ</h3>
        <p>ë‚´ êµ¬ì—­ / ì¤‘ì•™: <b style="color:#a855f7">+1</b></p>
        <p>ì  êµ¬ì—­: <b style="color:#f59e0b">+2</b> âš ï¸</p>
        <p>1ì´ˆ í›„ ì§€ì† ë°ë¯¸ì§€!</p>
      </div>
      <div class="info-card">
        <h3>âš”ï¸ í¬ë¦¬ì²˜</h3>
        <p>ì†Œí™˜ í›„ ìë™ ì¶”ì </p>
        <p>ì  ì ‘ì´‰ â†’ ì¦‰ì‚¬ ê³µê²©</p>
        <p>ìŠ¤í  ë§ìœ¼ë©´ ì¦‰ì‚¬</p>
      </div>
      <div class="info-card">
        <h3>ğŸ† ìŠ¹íŒ¨</h3>
        <p>3ì „ 2ì„ ìŠ¹ì œ</p>
        <p>ì  HP 0 = ë¼ìš´ë“œ ìŠ¹</p>
      </div>
    </div>
  </div>

  <!-- MULTI TAB -->
  <div id="tab-multi" class="tab-content">
    <div class="mp-panel">
      <h3>ğŸ  ë°© ë§Œë“¤ê¸°</h3>
      <button class="primary-btn orange" id="createRoomBtn">ë°© ìƒì„±</button>
      <div id="myRoomCode" style="display:none; margin-top:10px;">
        <p style="color:#94a3b8; font-size:12px; margin-bottom:6px;">ì´ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</p>
        <div class="room-code" id="roomCodeDisplay">----</div>
        <p class="status-text" id="hostStatus">ì¹œêµ¬ê°€ ì ‘ì†í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
      </div>
    </div>
    <div class="mp-panel">
      <h3>ğŸ”— ë°© ì°¸ê°€í•˜ê¸°</h3>
      <input class="mp-input" id="joinCodeInput" placeholder="ë°© ì½”ë“œ ì…ë ¥ (ì˜ˆ: AB12)" maxlength="4">
      <button class="primary-btn" id="joinRoomBtn">ì°¸ê°€í•˜ê¸°</button>
      <p class="status-text" id="joinStatus"></p>
    </div>
  </div>
</div>

<!-- â•â• CONNECTING â•â• -->
<div id="connectingScreen" class="screen hidden">
  <div class="spinner"></div>
  <h2>ì—°ê²° ì¤‘...</h2>
  <p id="connectingMsg" style="color:#94a3b8">ìƒëŒ€ë°©ê³¼ ì—°ê²°í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤</p>
  <button class="primary-btn ghost" style="max-width:200px;margin-top:10px" onclick="cancelConnect()">ì·¨ì†Œ</button>
</div>

<!-- â•â• GAME â•â• -->
<div id="gameScreen" class="screen hidden">
  <div class="side-panel" id="spellPanel"><div class="panel-title">ğŸ”¥ ìŠ¤í </div></div>
  <div id="center-col">
    <div id="hud">
      <div class="hud-side">
        <div class="hud-avatar">ğŸ§™â€â™‚ï¸</div>
        <div class="hud-bars">
          <div class="hud-bar-row">â¤ï¸<div class="hud-track"><div class="hud-fill hp" id="p-hp" style="width:100%"></div></div><span class="hud-val" id="p-hp-v">20</span></div>
          <div class="hud-bar-row">ğŸ’§<div class="hud-track"><div class="hud-fill mp" id="p-mp" style="width:0%"></div></div><span class="hud-val" id="p-mp-v">0</span></div>
        </div>
      </div>
      <div id="hud-mid">
        <div id="round-info">ROUND 1</div>
        <div id="timer">0:00</div>
        <div class="pips"><div class="pip" id="pip0"></div><div class="pip" id="pip1"></div><div class="pip" id="pip2"></div><div class="pip" id="pip3"></div></div>
      </div>
      <div class="hud-side right">
        <div class="hud-avatar">ğŸ§™â€â™€ï¸</div>
        <div class="hud-bars">
          <div class="hud-bar-row" style="flex-direction:row-reverse">â¤ï¸<div class="hud-track"><div class="hud-fill hp e" id="e-hp" style="width:100%"></div></div><span class="hud-val" id="e-hp-v">20</span></div>
          <div class="hud-bar-row" style="flex-direction:row-reverse">ğŸ’§<div class="hud-track"><div class="hud-fill mp" id="e-mp" style="width:0%"></div></div><span class="hud-val" id="e-mp-v">0</span></div>
        </div>
      </div>
    </div>
    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      <!-- D-PAD -->
      <div id="dpad">
        <div class="dpad-btn" id="dpad-up">â–²</div>
        <div class="dpad-btn" id="dpad-down">â–¼</div>
        <div class="dpad-btn" id="dpad-left">â—€</div>
        <div class="dpad-btn" id="dpad-right">â–¶</div>
        <div class="dpad-center" id="dpad-center"></div>
      </div>
      <div id="shoot-btn">ğŸ’¥</div>
    </div>
  </div>
  <div class="side-panel right" id="creaturePanel"><div class="panel-title">âš”ï¸ í¬ë¦¬ì²˜</div></div>
</div>

<!-- â•â• OVERLAY â•â• -->
<div id="overlayScreen" class="screen hidden">
  <h2 id="overlay-title"></h2>
  <p  id="overlay-sub"></p>
  <div class="overlay-btns">
    <button class="primary-btn" id="overlay-next">ê³„ì†</button>
    <button class="primary-btn ghost" id="overlay-quit">ë©”ë‰´ë¡œ</button>
  </div>
</div>

<!-- PeerJS CDN -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = {
  W:900, H:540, MID:450,
  MAX_HP:20, MAX_MANA:10,
  DANGER_GRACE:1000,   // â† 1ì´ˆ
  DANGER_DPS:1.5,
  ORB_INTERVAL:2200, MAX_ORBS:9,
  BASIC_CD:320, BASIC_DMG:1.5,
  MANA_REGEN:0.25,
};

const SPELL_DEFS = [
  { id:0, name:'í™”ì—¼êµ¬', cost:2, type:'proj', dmg:5,  spd:7,  size:14, color:'#ff4444', icon:'ğŸ”¥', cd:700  },
  { id:1, name:'ì¹˜ìœ ',   cost:2, type:'heal', heal:5,                   icon:'ğŸ’š',       cd:2500 },
  { id:2, name:'ë²ˆê°œ',   cost:3, type:'proj', dmg:8,  spd:13, size:11, color:'#faff00', icon:'âš¡', cd:1100 },
  { id:3, name:'ì–¼ìŒ',   cost:2, type:'proj', dmg:4,  spd:6,  size:17, color:'#60a5fa', icon:'â„ï¸', cd:550  },
];
const CREATURE_DEFS = [
  { id:0, name:'ê²€ì‚¬',   cost:2, atk:4, spd:2.8, icon:'âš”ï¸', size:22, color:'#22c55e', hp:1 },
  { id:1, name:'ê¶ìˆ˜',   cost:3, atk:5, spd:2.4, icon:'ğŸ¹', size:20, color:'#3b82f6', hp:1 },
  { id:2, name:'ë°©íŒ¨ë³‘', cost:2, atk:0, spd:0,   icon:'ğŸ›¡ï¸', size:26, color:'#9b59b6', hp:2, shield:true },
  { id:3, name:'ë§ˆë²•ì‚¬', cost:3, atk:6, spd:2.4, icon:'ğŸ”®', size:20, color:'#e74c3c', hp:1 },
];

// â”€â”€ UTIL â”€â”€
const dist  = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const clamp = (v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const rnd   = (lo,hi)=>lo+Math.random()*(hi-lo);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
function resizeCanvas(){
  const wrap=document.getElementById('canvas-wrap');
  const W2=wrap.clientWidth, H2=wrap.clientHeight;
  const scale=Math.min(W2/CFG.W, H2/CFG.H);
  canvas.width=CFG.W; canvas.height=CFG.H;
  canvas.style.width =(CFG.W*scale)+'px';
  canvas.style.height=(CFG.H*scale)+'px';
  canvas.style.left  =((W2-CFG.W*scale)/2)+'px';
  canvas.style.top   =((H2-CFG.H*scale)/2)+'px';
}
window.addEventListener('resize',resizeCanvas);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===(tab==='solo'?0:1)));
  document.getElementById('tab-solo').classList.toggle('active',tab==='solo');
  document.getElementById('tab-multi').classList.toggle('active',tab==='multi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={};
window.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(Game.state!=='playing') return;
  if(e.code==='Space') e.preventDefault();
  ['1','2','3','4'].forEach((k,i)=>{ if(e.key===k) Game.castSpell(i); });
  ['KeyQ','KeyW','KeyE','KeyR'].forEach((k,i)=>{ if(e.code===k) Game.summon(i); });
});
window.addEventListener('keyup',e=>{ keys[e.code]=false; });

// â”€â”€ D-PAD touch â”€â”€
const dpadKeys={up:false,down:false,left:false,right:false};
function bindDpad(id,key){
  const el=document.getElementById(id);
  if(!el) return;
  const press  =e=>{ e.preventDefault(); dpadKeys[key]=true;  el.classList.add('pressed'); };
  const release=e=>{ e.preventDefault(); dpadKeys[key]=false; el.classList.remove('pressed'); };
  el.addEventListener('touchstart',press,  {passive:false});
  el.addEventListener('touchend',  release,{passive:false});
  el.addEventListener('touchcancel',release,{passive:false});
  el.addEventListener('mousedown', press);
  el.addEventListener('mouseup',   release);
  el.addEventListener('mouseleave',release);
}
bindDpad('dpad-up','up'); bindDpad('dpad-down','down');
bindDpad('dpad-left','left'); bindDpad('dpad-right','right');

// â”€â”€ Shoot button â”€â”€
let mobileShoot=false;
const shootBtn=document.getElementById('shoot-btn');
shootBtn.addEventListener('touchstart',e=>{e.preventDefault();mobileShoot=true;},{passive:false});
shootBtn.addEventListener('touchend',  e=>{e.preventDefault();mobileShoot=false;},{passive:false});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTIPLAYER (PeerJS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let peer=null, conn=null, isHost=false, isMulti=false;

function makeCode(){
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:4},()=>c[Math.floor(Math.random()*c.length)]).join('');
}

function initPeer(id){
  return new Promise((res,rej)=>{
    const p=new Peer(id,{debug:0});
    p.on('open', ()=>res(p));
    p.on('error', rej);
    setTimeout(()=>rej(new Error('PeerJS íƒ€ì„ì•„ì›ƒ')),8000);
  });
}

document.getElementById('createRoomBtn').addEventListener('click', async()=>{
  const code=makeCode();
  const btn=document.getElementById('createRoomBtn');
  btn.disabled=true; btn.textContent='ìƒì„± ì¤‘...';
  try {
    peer=await initPeer('spell-arena-'+code);
    isHost=true;
    document.getElementById('myRoomCode').style.display='block';
    document.getElementById('roomCodeDisplay').textContent=code;
    document.getElementById('hostStatus').textContent='ì¹œêµ¬ê°€ ì ‘ì†í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
    document.getElementById('hostStatus').className='status-text';

    peer.on('connection',c=>{
      conn=c;
      setupConn();
      document.getElementById('hostStatus').textContent='âœ… ìƒëŒ€ë°© ì—°ê²°ë¨! ê²Œì„ ì‹œì‘ ì¤‘...';
      document.getElementById('hostStatus').className='status-text ok';
      setTimeout(()=>startMultiGame(),800);
    });
  } catch(err){
    document.getElementById('hostStatus').textContent='âŒ ì—°ê²° ì‹¤íŒ¨: '+err.message;
    document.getElementById('hostStatus').className='status-text err';
    btn.disabled=false; btn.textContent='ë°© ìƒì„±';
  }
});

document.getElementById('joinRoomBtn').addEventListener('click', async()=>{
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if(code.length!==4){ document.getElementById('joinStatus').textContent='4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”'; return; }
  const btn=document.getElementById('joinRoomBtn');
  btn.disabled=true;
  document.getElementById('joinStatus').textContent='ì—°ê²° ì¤‘...';
  document.getElementById('joinStatus').className='status-text';
  try {
    peer=await initPeer('spell-arena-guest-'+Math.random().toString(36).slice(2,8));
    isHost=false;
    conn=peer.connect('spell-arena-'+code,{reliable:true});
    conn.on('open',()=>{
      setupConn();
      document.getElementById('joinStatus').textContent='âœ… ì—°ê²°ë¨! ê²Œì„ ì‹œì‘ ì¤‘...';
      document.getElementById('joinStatus').className='status-text ok';
      setTimeout(()=>startMultiGame(),800);
    });
    conn.on('error',err=>{ document.getElementById('joinStatus').textContent='âŒ ì—°ê²° ì‹¤íŒ¨'; btn.disabled=false; });
    setTimeout(()=>{ if(!conn.open){ document.getElementById('joinStatus').textContent='âŒ ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ'; btn.disabled=false; }},6000);
  } catch(err){
    document.getElementById('joinStatus').textContent='âŒ '+err.message;
    btn.disabled=false;
  }
});

function setupConn(){
  conn.on('data', handleNetData);
  conn.on('close',()=>{
    if(Game.state==='playing'){
      alert('ìƒëŒ€ë°© ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤');
      location.reload();
    }
  });
}

function cancelConnect(){ location.reload(); }

// Net data handler
function handleNetData(data){
  if(!data||!data.type) return;
  if(data.type==='pos'){
    // update remote player position
    const r=Game.remotePlayer;
    if(r){ r.x=data.x; r.y=data.y; r.facing=data.facing; r.hp=data.hp; r.mana=data.mana; }
  }
  if(data.type==='proj'){
    Game.projectiles.push(new Projectile({
      x:data.x,y:data.y,vx:data.vx,vy:data.vy,
      dmg:data.dmg,size:data.size,color:data.color,owner:'remote',
    }));
  }
  if(data.type==='summon'){
    const def=CREATURE_DEFS[data.idx];
    if(def) Game.remotePlayer.creatures.push(new Creature(def,'remote',data.cx,data.cy));
  }
  if(data.type==='round'){ Game.handleRemoteRoundEnd(data); }
}

function netSend(data){ if(conn&&conn.open) try{ conn.send(data); }catch(e){} }

function startMultiGame(){
  isMulti=true;
  Game.roundNum=1; Game.playerWins=0; Game.enemyWins=0;
  Game.startRound();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Particle{
  constructor(x,y,color,n=8){
    this.dead=false; this._list=[];
    for(let i=0;i<n;i++){
      const a=rnd(0,Math.PI*2),s=rnd(1.5,4.5);
      this._list.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,color});
    }
  }
  update(){ this._list.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.88;p.vy*=.88;p.life-=.04;}); this._list=this._list.filter(p=>p.life>0); if(!this._list.length)this.dead=true; }
  draw(c){ this._list.forEach(p=>{ c.globalAlpha=Math.max(0,p.life); c.fillStyle=p.color; c.beginPath(); c.arc(p.x,p.y,3.5*p.life,0,Math.PI*2); c.fill(); }); c.globalAlpha=1; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROJECTILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Projectile{
  constructor({x,y,vx,vy,dmg,size,color,owner,basic=false}){
    Object.assign(this,{x,y,vx,vy,dmg,size,color,owner,basic,dead:false}); this._trail=[];
  }
  update(){
    this._trail.unshift({x:this.x,y:this.y}); if(this._trail.length>5)this._trail.pop();
    this.x+=this.vx; this.y+=this.vy;
    if(this.x<0||this.x>CFG.W||this.y<0||this.y>CFG.H) this.dead=true;
  }
  draw(c){
    this._trail.forEach((t,i)=>{ c.globalAlpha=(1-i/this._trail.length)*.4; c.fillStyle=this.color; c.beginPath(); c.arc(t.x,t.y,this.size*(1-i*.18),0,Math.PI*2); c.fill(); });
    c.globalAlpha=1; c.fillStyle=this.color; c.shadowBlur=20; c.shadowColor=this.color;
    c.beginPath(); c.arc(this.x,this.y,this.size,0,Math.PI*2); c.fill(); c.shadowBlur=0;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANA ORB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class ManaOrb{
  constructor(seed){
    const r=seed!==undefined?seed:Math.random();
    if(r<.3){      this.x=rnd(40,CFG.MID-80);       this.bonus=1; }
    else if(r<.7){ this.x=rnd(CFG.MID-100,CFG.MID+100); this.bonus=1; }
    else{          this.x=rnd(CFG.MID+80,CFG.W-40);  this.bonus=2; }
    this.y=rnd(60,CFG.H-60); this.pulse=rnd(0,Math.PI*2); this.dead=false; this.rich=(this.bonus>1);
  }
  update(){ this.pulse+=.06; }
  draw(c){
    const r=9+Math.sin(this.pulse)*2.5;
    const g=c.createRadialGradient(this.x,this.y,1,this.x,this.y,r);
    g.addColorStop(0,this.rich?'#fef08a':'#e9d5ff'); g.addColorStop(1,this.rich?'#f59e0b00':'#a855f700');
    c.fillStyle=g; c.shadowBlur=18; c.shadowColor=this.rich?'#f59e0b':'#a855f7';
    c.beginPath(); c.arc(this.x,this.y,r,0,Math.PI*2); c.fill(); c.shadowBlur=0;
    c.fillStyle=this.rich?'#fbbf24':'#d8b4fe'; c.font='bold 10px Segoe UI'; c.textAlign='center';
    c.fillText(`+${this.bonus}`,this.x,this.y+r+12);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CREATURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Creature{
  constructor(def,owner,x,y){
    Object.assign(this,def); this.owner=owner; this.x=x; this.y=y;
    this.currentHp=def.hp; this.dead=false; this.id=Math.random();
  }
  update(target){
    if(this.shield||this.spd===0) return;
    const dx=target.x-this.x,dy=target.y-this.y,d=Math.hypot(dx,dy);
    if(d>32){ this.x+=(dx/d)*this.spd; this.y+=(dy/d)*this.spd; }
    else{ target.hp=Math.max(0,target.hp-this.atk); this.dead=true; }
  }
  draw(c){
    const glowColor=this.owner==='player'?'#22c55e':this.owner==='remote'?'#f97316':'#f97316';
    c.fillStyle=this.color; c.shadowBlur=20; c.shadowColor=glowColor;
    c.beginPath(); c.arc(this.x,this.y,this.size,0,Math.PI*2); c.fill(); c.shadowBlur=0;
    c.strokeStyle='#fff'; c.lineWidth=2.5; c.stroke();
    c.font=`bold ${this.size+8}px Arial`; c.textAlign='center'; c.textBaseline='middle'; c.fillStyle='#fff';
    c.fillText(this.icon,this.x,this.y); c.textBaseline='alphabetic';
    if(this.hp>1){ const bw=this.size*2; c.fillStyle='rgba(0,0,0,.6)'; c.fillRect(this.x-bw/2,this.y-this.size-10,bw,5); c.fillStyle='#a855f7'; c.fillRect(this.x-bw/2,this.y-this.size-10,bw*(this.currentHp/this.hp),5); }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARACTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Character{
  constructor({x,y,color,label,facing,isPlayer,isRemote=false}){
    this.x=x; this.y=y; this.color=color; this.label=label;
    this.facing=facing; this.isPlayer=isPlayer; this.isRemote=isRemote;
    this.hp=CFG.MAX_HP; this.maxHp=CFG.MAX_HP;
    this.mana=0; this.maxMana=CFG.MAX_MANA;
    this.speed=isPlayer?3.8:2.6;
    this.creatures=[]; this.dangerTimer=0; this.basicCd=0; this.spellCd={};
  }
  isInDanger(){
    if(this.isPlayer)  return this.x > CFG.MID+40;
    if(this.isRemote)  return this.x < CFG.MID-40;
    return this.x < CFG.MID-40; // AI
  }
  updateDanger(dt){
    if(this.isInDanger()){ this.dangerTimer+=dt; if(this.dangerTimer>CFG.DANGER_GRACE) this.hp=Math.max(0,this.hp-CFG.DANGER_DPS*(dt/1000)); }
    else this.dangerTimer=Math.max(0,this.dangerTimer-dt*2);
  }
  tryBasicShot(dt,projectiles,isAI=false){
    this.basicCd-=dt;
    const shoot=isAI?(Math.random()<.012):(this.isPlayer?(keys['Space']||mobileShoot):false);
    if(this.basicCd<=0&&shoot){
      const dir=this.facing==='right'?1:-1;
      projectiles.push(new Projectile({
        x:this.x+dir*28,y:this.y-8,
        vx:dir*6.5,vy:rnd(-.4,.4),
        dmg:CFG.BASIC_DMG,size:7,
        color:this.isPlayer?'#c084fc':'#fb923c',
        owner:this.isPlayer?'player':'enemy',basic:true,
      }));
      this.basicCd=CFG.BASIC_CD;
    }
  }
  draw(c){
    const t=Date.now();
    const {x,y,color,facing,label}=this;
    const moving=this.isPlayer?(keys['ArrowLeft']||keys['ArrowRight']||keys['ArrowUp']||keys['ArrowDown']||keys['KeyA']||keys['KeyD']||keys['KeyW']||keys['KeyS']||dpadKeys.up||dpadKeys.down||dpadKeys.left||dpadKeys.right):true;
    const leg=moving?Math.sin(t*.012)*11:0, arm=moving?Math.sin(t*.012)*9:0;
    const dir=facing==='right'?1:-1;
    c.fillStyle='rgba(0,0,0,.3)'; c.beginPath(); c.ellipse(x,y+34,24,9,0,0,Math.PI*2); c.fill();
    c.strokeStyle=color+'bb'; c.lineWidth=13; c.lineCap='round';
    c.beginPath(); c.moveTo(x-7,y+20); c.lineTo(x-7,y+36+leg); c.stroke();
    c.beginPath(); c.moveTo(x+7,y+20); c.lineTo(x+7,y+36-leg); c.stroke();
    const bg=c.createLinearGradient(x-16,y-14,x+16,y+24);
    bg.addColorStop(0,color); bg.addColorStop(1,color+'88');
    c.fillStyle=bg; c.shadowBlur=12; c.shadowColor=color+'80';
    c.fillRect(x-16,y-14,32,38); c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.7)'; c.lineWidth=2.5; c.strokeRect(x-16,y-14,32,38);
    c.fillStyle='rgba(255,255,255,.12)'; c.fillRect(x-11,y-10,22,10);
    c.strokeStyle=color; c.lineWidth=11;
    c.beginPath(); c.moveTo(x-16,y-4); c.lineTo(x-26*dir,y+12+arm); c.stroke();
    c.beginPath(); c.moveTo(x+16,y-4); c.lineTo(x+28*dir,y+10-arm); c.stroke();
    c.fillStyle='#fbbf24'; c.shadowBlur=8; c.shadowColor='#fbbf2460';
    c.beginPath(); c.arc(x,y-28,17,0,Math.PI*2); c.fill(); c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.8)'; c.lineWidth=2.5; c.stroke();
    c.fillStyle='#111'; const ex=dir*5;
    c.fillRect(x+ex-4,y-32,4,4); c.fillRect(x+ex+4,y-32,4,4);
    c.strokeStyle='#333'; c.lineWidth=2; c.beginPath(); c.arc(x+ex,y-24,4,0,Math.PI); c.stroke();
    c.fillStyle='#fbbf24'; c.shadowBlur=10; c.shadowColor='#f59e0b';
    c.fillRect(x+22*dir,y-22,7,36); c.shadowBlur=0;
    c.fillStyle='#f59e0b'; c.fillRect(x+20*dir,y-26,11,9);
    const hpPct=this.hp/this.maxHp;
    c.fillStyle='rgba(0,0,0,.7)'; c.fillRect(x-34,y-52,68,9);
    const hbg=c.createLinearGradient(x-34,0,x+34,0);
    if(this.isPlayer){hbg.addColorStop(0,'#10b981');hbg.addColorStop(1,'#34d399');}
    else{hbg.addColorStop(0,'#ef4444');hbg.addColorStop(1,'#f87171');}
    c.fillStyle=hbg; c.fillRect(x-34,y-52,68*hpPct,9);
    c.strokeStyle='rgba(255,255,255,.3)'; c.lineWidth=1; c.strokeRect(x-34,y-52,68,9);
    c.font='bold 13px Segoe UI'; c.textAlign='center';
    c.strokeStyle='#000'; c.lineWidth=4; c.strokeText(label,x,y-64);
    c.fillStyle=color; c.fillText(label,x,y-64);
    if(this.dangerTimer>CFG.DANGER_GRACE){
      const a=.5+Math.sin(t*.012)*.4;
      c.strokeStyle=`rgba(239,68,68,${a})`; c.lineWidth=3; c.shadowBlur=12; c.shadowColor='#ef4444';
      c.beginPath(); c.arc(x,y,42,0,Math.PI*2); c.stroke(); c.shadowBlur=0;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI CONTROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class AIController{
  constructor(e,p){ this.e=e; this.p=p; this.target={x:e.x,y:e.y}; this.nextMoveT=0; this.spellT=0; this.creatureT=0; }
  update(now,orbs,projectiles){
    const e=this.e,p=this.p;
    if(now>this.nextMoveT){
      this.nextMoveT=now+rnd(600,1400);
      if(e.hp<e.maxHp*.35) this.target={x:rnd(CFG.MID+60,CFG.W-60),y:rnd(80,CFG.H-80)};
      else if(e.mana<4){
        const picks=[...orbs.filter(o=>o.rich),...orbs.filter(o=>o.x<CFG.MID)].sort((a,b)=>dist(e,a)-dist(e,b));
        if(picks[0]) this.target={x:picks[0].x,y:picks[0].y};
        else this.target={x:rnd(CFG.MID,CFG.W-50),y:rnd(80,CFG.H-80)};
      } else {
        const own=orbs.filter(o=>o.x>CFG.MID).sort((a,b)=>dist(e,a)-dist(e,b))[0];
        if(own) this.target={x:own.x,y:own.y};
        else this.target={x:rnd(CFG.MID+30,CFG.W-50),y:rnd(80,CFG.H-80)};
      }
    }
    const dx=this.target.x-e.x,dy=this.target.y-e.y,d=Math.hypot(dx,dy);
    if(d>6){e.x+=(dx/d)*e.speed;e.y+=(dy/d)*e.speed;}
    e.x=clamp(e.x,30,CFG.W-30); e.y=clamp(e.y,55,CFG.H-30);
    e.facing=e.x<CFG.MID?'right':'left';
    if(now>this.spellT&&e.mana>=2){
      const healNeeded=e.hp<e.maxHp*.5;
      const def=healNeeded?SPELL_DEFS[1]:(Math.random()<.55?SPELL_DEFS[0]:SPELL_DEFS[2]);
      if(e.mana>=def.cost){
        if(def.type==='heal'){e.hp=Math.min(e.maxHp,e.hp+def.heal);e.mana-=def.cost;}
        else{
          const angle=Math.atan2(p.y-e.y,p.x-e.x);
          projectiles.push(new Projectile({x:e.x-28,y:e.y-8,vx:Math.cos(angle)*def.spd,vy:Math.sin(angle)*def.spd,dmg:def.dmg,size:def.size,color:def.color,owner:'enemy'}));
          e.mana-=def.cost;
        }
        this.spellT=now+rnd(1000,2000);
      }
    }
    if(now>this.creatureT&&e.mana>=2&&e.creatures.length<5){
      const def=CREATURE_DEFS[Math.floor(Math.random()*CREATURE_DEFS.length)];
      if(e.mana>=def.cost){e.creatures.push(new Creature(def,'enemy',e.x-50,e.y+rnd(-50,50)));e.mana-=def.cost;this.creatureT=now+rnd(1500,3000);}
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Game={
  state:'menu',
  roundNum:1,playerWins:0,enemyWins:0,
  player:null,enemy:null,remotePlayer:null,
  projectiles:[],orbs:[],particles:[],
  ai:null,
  _orbTimer:null,_regenTimer:null,_roundSec:0,_roundInterval:null,_lastT:0,
  _netTimer:null,

  buildButtons(){
    const sp=document.getElementById('spellPanel');
    const cp=document.getElementById('creaturePanel');
    sp.querySelectorAll('.action-btn').forEach(b=>b.remove());
    cp.querySelectorAll('.action-btn').forEach(b=>b.remove());
    SPELL_DEFS.forEach((def,i)=>{
      const btn=document.createElement('button');
      btn.className='action-btn spell'; btn.id=`sp-btn-${i}`;
      btn.innerHTML=`<span class="key">${i+1}</span>${def.icon}<span class="cost">ğŸ’§${def.cost}</span>`;
      btn.addEventListener('pointerdown',e=>{e.preventDefault();Game.castSpell(i);});
      const cd=document.createElement('div'); cd.className='cd-mask'; cd.id=`sp-cd-${i}`; cd.style.display='none'; btn.appendChild(cd);
      sp.appendChild(btn);
    });
    const ck=['Q','W','E','R'];
    CREATURE_DEFS.forEach((def,i)=>{
      const btn=document.createElement('button');
      btn.className='action-btn creature'; btn.id=`cr-btn-${i}`;
      btn.innerHTML=`<span class="key">${ck[i]}</span>${def.icon}<span class="cost">ğŸ’§${def.cost}</span>`;
      btn.addEventListener('pointerdown',e=>{e.preventDefault();Game.summon(i);});
      cp.appendChild(btn);
    });
  },

  startRound(){
    this.projectiles=[]; this.orbs=[]; this.particles=[];
    this.player=new Character({x:160,y:CFG.H/2,color:'#60a5fa',label:'í”Œë ˆì´ì–´',facing:'right',isPlayer:true});

    if(isMulti){
      const remoteColor=isHost?'#f87171':'#f87171';
      const remoteLabel=isHost?'ìƒëŒ€ë°©':'ìƒëŒ€ë°©';
      this.remotePlayer=new Character({x:CFG.W-160,y:CFG.H/2,color:remoteColor,label:remoteLabel,facing:'left',isPlayer:false,isRemote:true});
      this.enemy=this.remotePlayer;
      this.ai=null;
    } else {
      this.enemy=new Character({x:CFG.W-160,y:CFG.H/2,color:'#f87171',label:'AI',facing:'left',isPlayer:false});
      this.ai=new AIController(this.enemy,this.player);
      this.remotePlayer=null;
    }

    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('overlayScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    resizeCanvas();

    this._roundSec=0;
    clearInterval(this._roundInterval);
    this._roundInterval=setInterval(()=>{
      this._roundSec++;
      const m=Math.floor(this._roundSec/60),s=this._roundSec%60;
      document.getElementById('timer').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    },1000);

    clearInterval(this._orbTimer);
    this._orbTimer=setInterval(()=>{
      if(this.state==='playing'&&this.orbs.length<CFG.MAX_ORBS){
        const seed=Math.random();
        // Host syncs orb seeds to guest
        if(isMulti&&isHost) netSend({type:'orb',seed});
        this.orbs.push(new ManaOrb(seed));
      }
    },CFG.ORB_INTERVAL);
    this.orbs.push(new ManaOrb()); this.orbs.push(new ManaOrb()); this.orbs.push(new ManaOrb());

    clearInterval(this._regenTimer);
    this._regenTimer=setInterval(()=>{
      if(this.state!=='playing') return;
      this.player.mana=Math.min(CFG.MAX_MANA,this.player.mana+CFG.MANA_REGEN);
      if(!isMulti) this.enemy.mana=Math.min(CFG.MAX_MANA,this.enemy.mana+CFG.MANA_REGEN);
      this.updateHUD();
    },1000);

    // Network position sync
    if(isMulti){
      clearInterval(this._netTimer);
      this._netTimer=setInterval(()=>{
        if(this.state!=='playing'||!this.player) return;
        netSend({type:'pos',x:this.player.x,y:this.player.y,facing:this.player.facing,hp:this.player.hp,mana:this.player.mana});
      },50);
    }

    this.updateRoundHUD();
    this.state='playing';
    this._lastT=performance.now();
    requestAnimationFrame(t=>this.loop(t));
  },

  castSpell(i){
    if(this.state!=='playing') return;
    const def=SPELL_DEFS[i],p=this.player,now=performance.now();
    if(!def||p.mana<def.cost) return;
    if(p.spellCd[i]&&now<p.spellCd[i]) return;
    if(def.type==='proj'){
      const dir=p.facing==='right'?1:-1;
      const pj=new Projectile({x:p.x+dir*28,y:p.y-8,vx:dir*def.spd,vy:0,dmg:def.dmg,size:def.size,color:def.color,owner:'player'});
      this.projectiles.push(pj);
      if(isMulti) netSend({type:'proj',x:pj.x,y:pj.y,vx:pj.vx,vy:pj.vy,dmg:pj.dmg,size:pj.size,color:pj.color});
      p.mana-=def.cost;
    } else if(def.type==='heal'){
      p.hp=Math.min(p.maxHp,p.hp+def.heal);
      this.particles.push(new Particle(p.x,p.y,'#34d399',14));
      p.mana-=def.cost;
    }
    p.spellCd[i]=now+def.cd; this.updateHUD();
  },

  summon(i){
    if(this.state!=='playing') return;
    const def=CREATURE_DEFS[i],p=this.player;
    if(!def||p.mana<def.cost||p.creatures.length>=8) return;
    const cx=p.x+50, cy=p.y+rnd(-60,60);
    p.creatures.push(new Creature(def,'player',cx,cy));
    if(isMulti) netSend({type:'summon',idx:i,cx,cy});
    p.mana-=def.cost; this.updateHUD();
  },

  handleRemoteRoundEnd(data){
    // remote player lost â†’ we won (or vice versa)
    if(data.remoteLost){ this.playerWins++; }
    else { this.enemyWins++; }
    this.state='roundOver';
    clearInterval(this._orbTimer); clearInterval(this._roundInterval);
    setTimeout(()=>this.showRoundResult(data.remoteLost),500);
  },

  loop(t){
    if(this.state!=='playing') return;
    const dt=Math.min(50,t-this._lastT); this._lastT=t;
    this.update(dt,t); this.render();
    requestAnimationFrame(ts=>this.loop(ts));
  },

  update(dt,now){
    const p=this.player,e=this.enemy;

    // â”€â”€ Player movement (keyboard + d-pad)
    let dx=0,dy=0;
    if(keys['ArrowLeft'] ||keys['KeyA']||dpadKeys.left){dx-=1;p.facing='left';}
    if(keys['ArrowRight']||keys['KeyD']||dpadKeys.right){dx+=1;p.facing='right';}
    if(keys['ArrowUp']   ||keys['KeyW']||dpadKeys.up)   dy-=1;
    if(keys['ArrowDown'] ||keys['KeyS']||dpadKeys.down)  dy+=1;
    if(dx&&dy){dx*=.707;dy*=.707;}
    p.x=clamp(p.x+dx*p.speed,28,CFG.W-28);
    p.y=clamp(p.y+dy*p.speed,55,CFG.H-30);

    // â”€â”€ Danger zones (1ì´ˆ = 1000ms)
    p.updateDanger(dt);
    if(!isMulti) e.updateDanger(dt);

    // â”€â”€ Basic shots
    p.tryBasicShot(dt,this.projectiles);
    if(!isMulti) e.tryBasicShot(dt,this.projectiles,true);

    // â”€â”€ AI
    if(this.ai) this.ai.update(now,this.orbs,this.projectiles);

    // â”€â”€ Orbs
    for(let i=this.orbs.length-1;i>=0;i--){
      const o=this.orbs[i]; o.update();
      if(dist(p,o)<22){ p.mana=Math.min(CFG.MAX_MANA,p.mana+o.bonus); this.particles.push(new Particle(o.x,o.y,o.rich?'#fbbf24':'#a855f7',12)); this.orbs.splice(i,1); }
      else if(dist(e,o)<22){ e.mana=Math.min(CFG.MAX_MANA,e.mana+o.bonus); this.orbs.splice(i,1); }
    }

    // â”€â”€ Projectiles
    for(let i=this.projectiles.length-1;i>=0;i--){
      const pj=this.projectiles[i]; pj.update();
      if(pj.dead){this.projectiles.splice(i,1);continue;}
      // In multiplayer, 'remote' projectiles hit the local player
      const ownersHitMe  = isMulti ? ['remote'] : ['enemy'];
      const ownersHitThem= isMulti ? ['player'] : ['player'];

      if(ownersHitThem.includes(pj.owner)){
        if(dist(pj,e)<32){ e.hp=Math.max(0,e.hp-pj.dmg); this.particles.push(new Particle(pj.x,pj.y,pj.color,8)); pj.dead=true; this.updateHUD(); continue; }
        let hit=false;
        for(let j=e.creatures.length-1;j>=0;j--){
          const cr=e.creatures[j];
          if(dist(pj,cr)<cr.size+pj.size){ this.particles.push(new Particle(cr.x,cr.y,cr.color,10));
            if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)e.creatures.splice(j,1);}else e.creatures.splice(j,1);
            pj.dead=true;hit=true;break; }
        }
        if(hit) continue;
      }
      if(ownersHitMe.includes(pj.owner)){
        if(dist(pj,p)<32){ p.hp=Math.max(0,p.hp-pj.dmg); this.particles.push(new Particle(pj.x,pj.y,pj.color,8)); pj.dead=true; this.updateHUD(); continue; }
        let hit=false;
        for(let j=p.creatures.length-1;j>=0;j--){
          const cr=p.creatures[j];
          if(dist(pj,cr)<cr.size+pj.size){ this.particles.push(new Particle(cr.x,cr.y,cr.color,10));
            if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)p.creatures.splice(j,1);}else p.creatures.splice(j,1);
            pj.dead=true;hit=true;break; }
        }
        if(hit) continue;
      }
      if(pj.dead) this.projectiles.splice(i,1);
    }

    // â”€â”€ Creatures
    p.creatures.forEach(c=>{c.update(e);if(c.dead){this.particles.push(new Particle(c.x,c.y,'#facc15',14));this.updateHUD();}});
    e.creatures.forEach(c=>{c.update(p);if(c.dead){this.particles.push(new Particle(c.x,c.y,'#facc15',14));this.updateHUD();}});
    p.creatures=p.creatures.filter(c=>!c.dead);
    e.creatures=e.creatures.filter(c=>!c.dead);

    // â”€â”€ Particles
    this.particles.forEach(pt=>pt.update()); this.particles=this.particles.filter(pt=>!pt.dead);

    this.updateHUD();

    // â”€â”€ Win check
    if(p.hp<=0||e.hp<=0){
      const won=p.hp>0;
      if(won) this.playerWins++; else this.enemyWins++;
      this.state='roundOver';
      clearInterval(this._orbTimer); clearInterval(this._roundInterval);
      if(isMulti) netSend({type:'round',remoteLost:won});
      setTimeout(()=>this.showRoundResult(won),500);
    }
  },

  render(){
    const c=ctx;
    const bg=c.createLinearGradient(0,0,CFG.W,CFG.H);
    bg.addColorStop(0,'#0d0b1a');bg.addColorStop(.5,'#14102a');bg.addColorStop(1,'#1a0f38');
    c.fillStyle=bg; c.fillRect(0,0,CFG.W,CFG.H);

    for(let i=0;i<60;i++){
      const sx=(i*157+13)%CFG.W,sy=(i*211+7)%CFG.H;
      c.globalAlpha=(Math.sin(Date.now()*.0008+i)*.4+.6)*.45; c.fillStyle='#fff';
      c.fillRect(sx,sy,(i%2)+1,(i%2)+1);
    }
    c.globalAlpha=1;

    const pDanger=this.player.isInDanger()&&this.player.dangerTimer>CFG.DANGER_GRACE;
    c.fillStyle=`rgba(239,68,68,${pDanger?.12:.04})`; c.fillRect(CFG.MID,0,CFG.MID,CFG.H);
    c.fillStyle=`rgba(59,130,246,.04)`;                c.fillRect(0,0,CFG.MID,CFG.H);

    c.font='bold 11px Segoe UI'; c.textAlign='center';
    c.fillStyle='rgba(148,163,184,.28)';
    c.fillText('ë‚´ êµ¬ì—­',CFG.MID/2,18); c.fillText('ì  êµ¬ì—­',CFG.MID+CFG.MID/2,18);
    c.fillStyle='rgba(251,191,36,.18)'; c.fillText('+2 ìœ„í—˜ / 1ì´ˆ í›„ ë°ë¯¸ì§€',CFG.MID+CFG.MID/2,32);

    c.strokeStyle='#a855f7'; c.lineWidth=3; c.setLineDash([14,12]);
    c.shadowBlur=16; c.shadowColor='#a855f780';
    c.beginPath(); c.moveTo(CFG.MID,0); c.lineTo(CFG.MID,CFG.H); c.stroke();
    c.setLineDash([]); c.shadowBlur=0;

    // Danger countdown
    if(this.player.dangerTimer>0&&this.player.isInDanger()){
      const pct=Math.min(1,this.player.dangerTimer/CFG.DANGER_GRACE);
      if(pct<1){
        const remaining=((CFG.DANGER_GRACE-this.player.dangerTimer)/1000).toFixed(1);
        c.fillStyle='rgba(251,191,36,.9)'; c.font='bold 13px Segoe UI'; c.textAlign='center';
        c.fillText(`âš ï¸ ${remaining}s`,this.player.x,this.player.y-72);
      } else {
        c.fillStyle='rgba(239,68,68,.95)'; c.font='bold 13px Segoe UI'; c.textAlign='center';
        c.fillText('âš ï¸ ë°ë¯¸ì§€!',this.player.x,this.player.y-72);
      }
    }

    this.orbs.forEach(o=>o.draw(c));
    this.projectiles.forEach(pj=>pj.draw(c));
    this.player.creatures.forEach(cr=>cr.draw(c));
    this.enemy.creatures.forEach(cr=>cr.draw(c));
    this.particles.forEach(pt=>pt.draw(c));
    this.enemy.draw(c);
    this.player.draw(c);
  },

  updateHUD(){
    if(!this.player) return;
    const p=this.player,e=this.enemy;
    const ph=Math.max(0,p.hp),eh=Math.max(0,e.hp);
    document.getElementById('p-hp').style.width=(ph/p.maxHp*100)+'%';
    document.getElementById('p-hp').className='hud-fill hp'+(ph/p.maxHp<.3?' low':'');
    document.getElementById('p-hp-v').textContent=Math.ceil(ph);
    document.getElementById('p-mp').style.width=(p.mana/p.maxMana*100)+'%';
    document.getElementById('p-mp-v').textContent=Math.floor(p.mana);
    document.getElementById('e-hp').style.width=(eh/e.maxHp*100)+'%';
    document.getElementById('e-hp-v').textContent=Math.ceil(eh);
    document.getElementById('e-mp').style.width=(e.mana/e.maxMana*100)+'%';
    document.getElementById('e-mp-v').textContent=Math.floor(e.mana);
    const now=performance.now();
    SPELL_DEFS.forEach((_,i)=>{
      const btn=document.getElementById(`sp-btn-${i}`),cd=document.getElementById(`sp-cd-${i}`);
      if(!btn||!cd) return;
      const rem=(p.spellCd[i]||0)-now;
      if(rem>0){cd.style.display='flex';cd.textContent=(rem/1000).toFixed(1)+'s';}else cd.style.display='none';
      btn.disabled=p.mana<SPELL_DEFS[i].cost;
    });
    CREATURE_DEFS.forEach((_,i)=>{ const btn=document.getElementById(`cr-btn-${i}`); if(btn) btn.disabled=p.mana<CREATURE_DEFS[i].cost||p.creatures.length>=8; });
  },

  updateRoundHUD(){
    document.getElementById('round-info').textContent=`ROUND ${this.roundNum}`;
    ['pip0','pip1','pip2','pip3'].forEach((id,i)=>{
      const el=document.getElementById(id); if(!el) return;
      el.className='pip';
      const total=this.playerWins+this.enemyWins;
      if(i<total){ el.classList.add(i<this.playerWins?'p':'e'); }
    });
  },

  showRoundResult(playerWon){
    const over=document.getElementById('overlayScreen');
    const title=document.getElementById('overlay-title');
    const sub=document.getElementById('overlay-sub');
    const next=document.getElementById('overlay-next');
    over.classList.remove('hidden');
    const gameOver=this.playerWins>=2||this.enemyWins>=2;
    if(gameOver){
      title.textContent=this.playerWins>=2?'ğŸ‰ ìµœì¢… ìŠ¹ë¦¬!':'ğŸ’€ ìµœì¢… íŒ¨ë°°';
      title.style.color=this.playerWins>=2?'#34d399':'#f87171';
      sub.textContent=`${this.playerWins} : ${this.enemyWins} â€” 3ì „ 2ì„ ìŠ¹`;
      next.textContent='ë‹¤ì‹œ í”Œë ˆì´';
      next.onclick=()=>{ this.playerWins=0;this.enemyWins=0;this.roundNum=1;over.classList.add('hidden');this.startRound(); };
    } else {
      title.textContent=playerWon?`ğŸ† ë¼ìš´ë“œ ${this.roundNum} ìŠ¹ë¦¬!`:`ğŸ’” ë¼ìš´ë“œ ${this.roundNum} íŒ¨ë°°`;
      title.style.color=playerWon?'#34d399':'#f87171';
      sub.textContent=`ì „ì  ${this.playerWins} : ${this.enemyWins}`;
      next.textContent='ë‹¤ìŒ ë¼ìš´ë“œ'; this.roundNum++;
      next.onclick=()=>{ over.classList.add('hidden');this.updateRoundHUD();this.startRound(); };
    }
    document.getElementById('overlay-quit').onclick=()=>{
      this.playerWins=0;this.enemyWins=0;this.roundNum=1;
      clearInterval(this._orbTimer);clearInterval(this._regenTimer);clearInterval(this._roundInterval);clearInterval(this._netTimer);
      if(peer){peer.destroy();peer=null;} conn=null; isMulti=false; isHost=false;
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('overlayScreen').classList.add('hidden');
      document.getElementById('menuScreen').classList.remove('hidden');
      this.state='menu';
    };
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Game.buildButtons();
resizeCanvas();

document.getElementById('startSoloBtn').addEventListener('click',()=>{
  isMulti=false; Game.roundNum=1; Game.playerWins=0; Game.enemyWins=0; Game.startRound();
});

// Handle orb sync from host
const _origHandleNetData = handleNetData;
function handleNetData(data){
  if(data&&data.type==='orb'){ Game.orbs.push(new ManaOrb(data.seed)); return; }
  _origHandleNetData(data);
}
</script>
</body>
</html>
