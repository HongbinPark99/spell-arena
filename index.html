
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ìŠ¤í  ì•„ë ˆë‚˜</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:#0a0a12;font-family:'Segoe UI',sans-serif;
  overflow:hidden;touch-action:none;
  display:flex;align-items:center;justify-content:center;
  height:100dvh;width:100dvw;
}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.screen.hidden{display:none!important;}

/* â”€â”€ MENU â”€â”€ */
#menuScreen{
  background:radial-gradient(ellipse at 50% 40%,#1e1040 0%,#0a0a12 70%);
  color:white;gap:10px;text-align:center;padding:16px;overflow-y:auto;
}
#menuScreen h1{
  font-size:clamp(20px,5.5vw,44px);
  background:linear-gradient(90deg,#a855f7,#ec4899,#f59e0b);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 16px #a855f7aa);
}
.tagline{color:#c4b5fd;font-size:clamp(10px,1.8vw,13px);font-style:italic;}
.vs-row{font-size:clamp(28px,6vw,52px);}
.mode-tabs{display:flex;gap:8px;width:100%;max-width:480px;}
.tab-btn{
  flex:1;padding:9px 16px;font-size:clamp(12px,2vw,15px);font-weight:700;
  border:2px solid rgba(168,85,247,.4);border-radius:12px;
  background:transparent;color:#c4b5fd;cursor:pointer;transition:all .2s;
}
.tab-btn.active{background:linear-gradient(135deg,#7c3aed,#ec4899);border-color:transparent;color:white;}
.tab-content{display:none;width:100%;max-width:480px;}
.tab-content.active{display:flex;flex-direction:column;gap:8px;align-items:center;}
.mp-panel{
  background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.3);
  border-radius:14px;padding:14px;width:100%;text-align:left;
}
.mp-panel h3{color:#a855f7;margin-bottom:8px;font-size:13px;}
.mp-input{
  width:100%;padding:9px 12px;border-radius:10px;
  background:rgba(255,255,255,.08);border:1.5px solid rgba(168,85,247,.4);
  color:white;font-size:16px;outline:none;margin-bottom:7px;font-family:inherit;
  text-transform:uppercase;letter-spacing:3px;text-align:center;
}
.mp-input:focus{border-color:#a855f7;}
.room-code{
  font-size:clamp(24px,5vw,32px);font-weight:900;letter-spacing:6px;
  color:#f59e0b;text-align:center;padding:8px;
  background:rgba(245,158,11,.1);border-radius:8px;border:1.5px solid rgba(245,158,11,.3);
}
.status-text{font-size:11px;color:#94a3b8;text-align:center;min-height:15px;margin-top:5px;}
.status-text.ok{color:#34d399;}.status-text.err{color:#f87171;}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;max-width:min(480px,92vw);font-size:clamp(9px,1.5vw,12px);}
.info-card{background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.25);border-radius:10px;padding:9px;}
.info-card h3{color:#a855f7;margin-bottom:4px;font-size:1em;}
.info-card p{color:#e0e7ff;margin:1px 0;}
.primary-btn{
  padding:9px 28px;font-size:clamp(13px,2.2vw,16px);font-weight:700;
  background:linear-gradient(135deg,#a855f7,#ec4899);color:white;
  border:none;border-radius:30px;cursor:pointer;
  box-shadow:0 5px 20px #a855f760;transition:transform .15s,box-shadow .15s;width:100%;
}
.primary-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px #a855f790;}
.primary-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.primary-btn.ghost{background:linear-gradient(135deg,#374151,#4b5563);}
.primary-btn.orange{background:linear-gradient(135deg,#d97706,#f59e0b);}

/* â”€â”€ GAME SCREEN â”€â”€ */
#gameScreen{flex-direction:row;align-items:stretch;background:#0a0a12;}
.side-panel{
  width:clamp(60px,10vw,120px);
  background:rgba(15,14,30,.92);flex-shrink:0;
  display:flex;flex-direction:column;gap:4px;padding:5px 4px;
  border-right:1px solid rgba(168,85,247,.18);
}
.side-panel.right{border-right:none;border-left:1px solid rgba(168,85,247,.18);}
.panel-title{font-size:8px;color:#a855f7;font-weight:700;text-align:center;margin-bottom:2px;}
.action-btn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:1px;padding:6px 3px;border:none;border-radius:9px;cursor:pointer;
  font-size:clamp(15px,2.5vw,20px);position:relative;overflow:hidden;
  transition:transform .1s,opacity .2s;box-shadow:0 3px 8px #0005;
}
.action-btn:active{transform:scale(.88);}
.action-btn.spell{background:linear-gradient(135deg,#7c3aed,#ec4899);}
.action-btn.creature{background:linear-gradient(135deg,#059669,#0891b2);}
.action-btn:disabled{opacity:.3;cursor:not-allowed;}
.action-btn .key{position:absolute;top:2px;right:3px;font-size:6px;color:rgba(255,255,255,.5);font-weight:700;}
.action-btn .cost{font-size:7px;color:rgba(255,255,255,.85);}
.cd-mask{
  position:absolute;inset:0;background:rgba(0,0,0,.65);
  display:flex;align-items:center;justify-content:center;
  font-size:9px;color:#fff;font-weight:700;border-radius:9px;
}
#center-col{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* â”€â”€ HUD â”€â”€ */
#hud{
  display:flex;align-items:center;justify-content:space-between;
  padding:4px 6px;gap:4px;flex-shrink:0;
  background:rgba(10,10,20,.9);border-bottom:1px solid rgba(168,85,247,.18);
}
.hud-side{display:flex;align-items:center;gap:5px;flex:1;min-width:0;}
.hud-side.right{flex-direction:row-reverse;}
.hud-avatar{font-size:16px;flex-shrink:0;}
.hud-bars{display:flex;flex-direction:column;gap:3px;flex:1;min-width:0;}
.hud-bar-row{display:flex;align-items:center;gap:3px;font-size:8px;color:#e2e8f0;}
.hud-track{flex:1;height:5px;background:rgba(255,255,255,.12);border-radius:3px;overflow:hidden;min-width:20px;}
.hud-fill{height:100%;border-radius:3px;transition:width .15s;}
.hud-fill.hp{background:linear-gradient(90deg,#10b981,#34d399);}
.hud-fill.hp.low{background:linear-gradient(90deg,#ef4444,#f87171);}
.hud-fill.mp{background:linear-gradient(90deg,#6366f1,#a855f7);}
.hud-val{font-size:8px;font-weight:700;min-width:14px;}
#hud-mid{display:flex;flex-direction:column;align-items:center;gap:1px;flex-shrink:0;}
#round-info{font-size:7px;color:#c4b5fd;font-weight:700;letter-spacing:.5px;}
#timer{font-size:14px;color:#a855f7;font-weight:800;line-height:1;}
.pips{display:flex;gap:3px;}
.pip{width:7px;height:7px;border-radius:50%;border:1.5px solid #4b5563;background:transparent;transition:all .3s;}
.pip.p{background:#3b82f6;border-color:#3b82f6;}
.pip.e{background:#ef4444;border-color:#ef4444;}

/* â”€â”€ CANVAS â”€â”€ */
#canvas-wrap{flex:1;position:relative;overflow:hidden;min-height:0;background:#0a0a12;}
#gameCanvas{display:block;touch-action:none;position:absolute;}

/* â”€â”€ OVERLAY â”€â”€ */
#overlayScreen{background:rgba(5,5,15,.92);z-index:50;gap:12px;color:white;text-align:center;padding:20px;}
#overlayScreen h2{font-size:clamp(20px,5vw,40px);}
#overlayScreen p{color:#c4b5fd;font-size:clamp(10px,2vw,14px);}
.overlay-btns{display:flex;gap:10px;justify-content:center;margin-top:6px;}

/* â”€â”€ 360Â° JOYSTICK â”€â”€ */
#joystick-zone{
  position:absolute;bottom:12px;left:12px;
  width:128px;height:128px;
  display:none;z-index:40;touch-action:none;user-select:none;
}
#joystick-base{
  width:100%;height:100%;border-radius:50%;
  background:rgba(168,85,247,.10);
  border:2.5px solid rgba(168,85,247,.45);
  position:relative;
  box-shadow:0 0 20px rgba(168,85,247,.15),inset 0 0 20px rgba(0,0,0,.3);
}
/* Direction indicators */
#joystick-base::before{
  content:'';
  position:absolute;inset:8px;border-radius:50%;
  border:1px dashed rgba(168,85,247,.2);
}
/* Cardinal tick marks */
#joystick-base::after{
  content:'';position:absolute;inset:0;border-radius:50%;
  background:
    linear-gradient(0deg,transparent 47%,rgba(168,85,247,.25) 47%,rgba(168,85,247,.25) 53%,transparent 53%),
    linear-gradient(90deg,transparent 47%,rgba(168,85,247,.25) 47%,rgba(168,85,247,.25) 53%,transparent 53%);
}
#joystick-stick{
  width:50px;height:50px;border-radius:50%;
  background:radial-gradient(circle at 33% 33%,#d8b4fe,#7c3aed 60%,#5b21b6);
  border:2.5px solid rgba(255,255,255,.4);
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  box-shadow:0 4px 20px #7c3aed90,0 0 8px rgba(255,255,255,.2);
  pointer-events:none;
  /* Inner shine */
  overflow:hidden;
}
#joystick-stick::after{
  content:'';position:absolute;
  top:6px;left:8px;width:18px;height:10px;border-radius:50%;
  background:rgba(255,255,255,.25);
}
/* Directional arrow on stick */
#stick-arrow{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:14px;color:rgba(255,255,255,.7);pointer-events:none;
  transition:transform .05s;
}

/* â”€â”€ ACTION BUTTONS (mobile) â”€â”€ */
#mobile-actions{
  position:absolute;bottom:12px;right:12px;
  display:none;flex-direction:column;gap:8px;
  z-index:40;touch-action:none;
}
.mob-btn{
  width:58px;height:58px;border-radius:50%;
  border:2.5px solid rgba(255,255,255,.3);
  font-size:20px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;touch-action:none;user-select:none;
  box-shadow:0 4px 16px rgba(0,0,0,.5);
  transition:transform .1s;
}
.mob-btn:active{transform:scale(.85);}
#mob-shoot{background:radial-gradient(circle at 35% 35%,#f97316,#dc2626);}
#mob-spell1{background:radial-gradient(circle at 35% 35%,#c084fc,#7c3aed);}
#mob-spell2{background:radial-gradient(circle at 35% 35%,#34d399,#059669);}

/* Show on touch/narrow (Galaxy Fold inner ~280px, outer ~375px, regular mobile â‰¤820px) */
@media (max-width:900px),(pointer:coarse),(max-device-width:900px){
  .side-panel{width:clamp(50px,8vw,72px);}
  .action-btn{font-size:13px;padding:5px 2px;}
  #joystick-zone,#mobile-actions{display:flex;}
}
</style>
</head>
<body>

<!-- â•â• MENU â•â• -->
<div id="menuScreen" class="screen">
  <h1>âš”ï¸ SPELL ARENA âš”ï¸</h1>
  <p class="tagline">ë§ˆë‚˜ëŠ” ë°”ë‹¥ì— ìˆê³ , ê·¸ê±¸ ë¨¹ìœ¼ëŸ¬ ê°€ëŠ” ìˆœê°„ ì•½ì ì´ ëœë‹¤</p>
  <div class="vs-row">ğŸ§™â€â™‚ï¸ VS ğŸ§™â€â™€ï¸</div>
  <div class="mode-tabs">
    <button class="tab-btn active" onclick="switchTab('solo')">ğŸ¤– ì†”ë¡œ (vs AI)</button>
    <button class="tab-btn" onclick="switchTab('multi')">ğŸŒ ë©€í‹°í”Œë ˆì´</button>
  </div>
  <div id="tab-solo" class="tab-content active">
    <button class="primary-btn" id="startSoloBtn">âš¡ ê²Œì„ ì‹œì‘</button>
    <div class="info-grid">
      <div class="info-card"><h3>ğŸ® ì¡°ì‘</h3><p>WASD / ë°©í–¥í‚¤: ì´ë™</p><p>Space: ê¸°ë³¸ê³µê²©</p><p>1~4: ìŠ¤í  / Q~R: í¬ë¦¬ì²˜</p><p>ëª¨ë°”ì¼: ì¡°ì´ìŠ¤í‹± ì§€ì›</p></div>
      <div class="info-card"><h3>ğŸ’ ë§ˆë‚˜ ì˜¤ë¸Œ</h3><p>ë‚´ êµ¬ì—­ / ì¤‘ì•™: <b style="color:#a855f7">+1</b></p><p>ì  êµ¬ì—­: <b style="color:#f59e0b">+2</b> âš ï¸</p><p>1ì´ˆ í›„ ì§€ì† ë°ë¯¸ì§€!</p></div>
      <div class="info-card"><h3>âš”ï¸ í¬ë¦¬ì²˜</h3><p>ì†Œí™˜ í›„ ìë™ ì¶”ì </p><p>ì  ì ‘ì´‰ â†’ í­ë°œ ê³µê²©</p></div>
      <div class="info-card"><h3>ğŸ† ìŠ¹íŒ¨</h3><p>3ì „ 2ì„ ìŠ¹ì œ</p><p>ì  HP 0 = ë¼ìš´ë“œ ìŠ¹</p></div>
    </div>
  </div>
  <div id="tab-multi" class="tab-content">
    <div class="mp-panel">
      <h3>ğŸ  ë°© ë§Œë“¤ê¸°</h3>
      <button class="primary-btn orange" id="createRoomBtn">ë°© ìƒì„±í•˜ê¸°</button>
      <div id="myRoomCode" style="display:none;margin-top:10px;">
        <p style="color:#94a3b8;font-size:11px;margin-bottom:5px;">ì´ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</p>
        <div class="room-code" id="roomCodeDisplay">----</div>
        <p class="status-text" id="hostStatus">ì¹œêµ¬ê°€ ì ‘ì†í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
      </div>
    </div>
    <div class="mp-panel">
      <h3>ğŸ”— ë°© ì°¸ê°€í•˜ê¸°</h3>
      <input class="mp-input" id="joinCodeInput" placeholder="ì½”ë“œ ì…ë ¥" maxlength="4">
      <button class="primary-btn" id="joinRoomBtn">ì°¸ê°€í•˜ê¸°</button>
      <p class="status-text" id="joinStatus"></p>
    </div>
  </div>
</div>

<!-- â•â• GAME â•â• -->
<div id="gameScreen" class="screen hidden">
  <div class="side-panel" id="spellPanel"><div class="panel-title">ğŸ”¥ ìŠ¤í </div></div>
  <div id="center-col">
    <div id="hud">
      <div class="hud-side">
        <div class="hud-avatar">ğŸ§™â€â™‚ï¸</div>
        <div class="hud-bars">
          <div class="hud-bar-row">â¤ï¸<div class="hud-track"><div class="hud-fill hp" id="p-hp" style="width:100%"></div></div><span class="hud-val" id="p-hp-v">20</span></div>
          <div class="hud-bar-row">ğŸ’§<div class="hud-track"><div class="hud-fill mp" id="p-mp" style="width:0%"></div></div><span class="hud-val" id="p-mp-v">0</span></div>
        </div>
      </div>
      <div id="hud-mid">
        <div id="round-info">ROUND 1</div>
        <div id="timer">0:00</div>
        <div class="pips"><div class="pip" id="pip0"></div><div class="pip" id="pip1"></div><div class="pip" id="pip2"></div><div class="pip" id="pip3"></div></div>
      </div>
      <div class="hud-side right">
        <div class="hud-avatar">ğŸ§™â€â™€ï¸</div>
        <div class="hud-bars">
          <div class="hud-bar-row" style="flex-direction:row-reverse">â¤ï¸<div class="hud-track"><div class="hud-fill hp" id="e-hp" style="width:100%"></div></div><span class="hud-val" id="e-hp-v">20</span></div>
          <div class="hud-bar-row" style="flex-direction:row-reverse">ğŸ’§<div class="hud-track"><div class="hud-fill mp" id="e-mp" style="width:0%"></div></div><span class="hud-val" id="e-mp-v">0</span></div>
        </div>
      </div>
    </div>
    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      <!-- 360Â° Joystick -->
      <div id="joystick-zone">
        <div id="joystick-base">
          <div id="joystick-stick"><div id="stick-arrow">â–²</div></div>
        </div>
      </div>
      <!-- Mobile action buttons -->
      <div id="mobile-actions">
        <div class="mob-btn" id="mob-spell1">ğŸ”¥</div>
        <div class="mob-btn" id="mob-shoot">ğŸ’¥</div>
        <div class="mob-btn" id="mob-spell2">âš¡</div>
      </div>
    </div>
  </div>
  <div class="side-panel right" id="creaturePanel"><div class="panel-title">âš”ï¸ í¬ë¦¬ì²˜</div></div>
</div>

<!-- â•â• OVERLAY â•â• -->
<div id="overlayScreen" class="screen hidden">
  <h2 id="overlay-title"></h2>
  <p id="overlay-sub"></p>
  <div class="overlay-btns">
    <button class="primary-btn" id="overlay-next">ê³„ì†</button>
    <button class="primary-btn ghost" id="overlay-quit">ë©”ë‰´ë¡œ</button>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG={
  W:900,H:540,MID:450,
  MAX_HP:20,MAX_MANA:10,
  DANGER_GRACE:1000,
  DANGER_DPS:1.5,
  ORB_INTERVAL:2200,MAX_ORBS:9,
  BASIC_CD:320,BASIC_DMG:1.5,
  MANA_REGEN:0.25,
  NET_HZ:30,          // 30hz sync - smoother
};
const SPELL_DEFS=[
  {id:0,name:'í™”ì—¼êµ¬',cost:2,type:'proj',dmg:5, spd:5, size:14,color:'#ff4444',icon:'ğŸ”¥',cd:700},
  {id:1,name:'ì¹˜ìœ ',  cost:2,type:'heal',heal:5,                icon:'ğŸ’š',      cd:2500},
  {id:2,name:'ë²ˆê°œ',  cost:3,type:'proj',dmg:8, spd:10,size:11,color:'#faff00',icon:'âš¡',cd:1100},
  {id:3,name:'ì–¼ìŒ',  cost:2,type:'proj',dmg:4, spd:4.5, size:17,color:'#60a5fa',icon:'â„ï¸',cd:550},
];
const CREATURE_DEFS=[
  {id:0,name:'ê²€ì‚¬',  cost:2,atk:4,spd:2.8,icon:'âš”ï¸',size:22,color:'#22c55e',hp:1},
  {id:1,name:'ê¶ìˆ˜',  cost:3,atk:5,spd:2.4,icon:'ğŸ¹',size:20,color:'#3b82f6',hp:1},
  {id:2,name:'ë°©íŒ¨ë³‘',cost:2,atk:0,spd:0,  icon:'ğŸ›¡ï¸',size:26,color:'#9b59b6',hp:2,shield:true},
  {id:3,name:'ë§ˆë²•ì‚¬',cost:3,atk:6,spd:2.4,icon:'ğŸ”®',size:20,color:'#e74c3c',hp:1},
];
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const rnd=(lo,hi)=>lo+Math.random()*(hi-lo);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
function resizeCanvas(){
  const wrap=document.getElementById('canvas-wrap');
  const W2=wrap.clientWidth,H2=wrap.clientHeight;
  const scale=Math.min(W2/CFG.W,H2/CFG.H);
  canvas.width=CFG.W;canvas.height=CFG.H;
  canvas.style.width=(CFG.W*scale)+'px';
  canvas.style.height=(CFG.H*scale)+'px';
  canvas.style.left=((W2-CFG.W*scale)/2)+'px';
  canvas.style.top=((H2-CFG.H*scale)/2)+'px';
}
window.addEventListener('resize',resizeCanvas);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOBILE DETECTION (Galaxy Fold + all touch devices)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isMobileDevice(){
  // Touch capability
  if(navigator.maxTouchPoints>0) return true;
  // Pointer coarse (finger)
  if(window.matchMedia('(pointer:coarse)').matches) return true;
  // Narrow screen (covers Galaxy Fold inner 280px, outer 375px)
  if(window.innerWidth<=900||window.innerHeight<=600) return true;
  // User agent fallback
  if(/Android|iPhone|iPad|iPod|Mobile|Tablet/i.test(navigator.userAgent)) return true;
  return false;
}
function applyMobileUI(){
  const mobile=isMobileDevice();
  document.getElementById('joystick-zone').style.display=mobile?'block':'none';
  document.getElementById('mobile-actions').style.display=mobile?'flex':'none';
}
window.addEventListener('resize',applyMobileUI);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===(t==='solo'?0:1)));
  document.getElementById('tab-solo').classList.toggle('active',t==='solo');
  document.getElementById('tab-multi').classList.toggle('active',t==='multi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keys={};
window.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Space') e.preventDefault();
  if(G.state!=='playing') return;
  ['1','2','3','4'].forEach((k,i)=>{if(e.key===k) G.castSpell(i);});
  ['KeyQ','KeyW','KeyE','KeyR'].forEach((k,i)=>{if(e.code===k) G.summon(i);});
});
window.addEventListener('keyup',e=>{keys[e.code]=false;});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  360Â° ANALOG JOYSTICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const joy={dx:0,dy:0,moving:false,angle:0};
let _joyTid=null;
const joyZone=document.getElementById('joystick-zone');
const joyBase=document.getElementById('joystick-base');
const joyStick=document.getElementById('joystick-stick');
const stickArrow=document.getElementById('stick-arrow');
const JOY_R=48; // max stick displacement radius

function _getBaseCenter(){
  const r=joyBase.getBoundingClientRect();
  return{cx:r.left+r.width/2, cy:r.top+r.height/2, w:r.width, h:r.height};
}

function _joySet(cx,cy){
  const{cx:bx,cy:by,w,h}=_getBaseCenter();
  let dx=cx-bx, dy=cy-by;
  const mag=Math.hypot(dx,dy);
  if(mag>JOY_R){const s=JOY_R/mag;dx*=s;dy*=s;}

  // Position stick visually
  joyStick.style.left=(w/2+dx)+'px';
  joyStick.style.top=(h/2+dy)+'px';
  joyStick.style.transform='translate(-50%,-50%)';

  // Calculate normalized direction
  joy.dx=dx/JOY_R;
  joy.dy=dy/JOY_R;
  joy.moving=Math.hypot(dx,dy)>8;

  // Rotate arrow to show direction
  if(joy.moving){
    joy.angle=Math.atan2(dy,dx)*(180/Math.PI)+90;
    stickArrow.style.transform=`rotate(${joy.angle}deg)`;
    stickArrow.style.opacity='0.8';
  } else {
    stickArrow.style.opacity='0.3';
  }
}

function _joyReset(){
  const{w,h}=_getBaseCenter();
  joyStick.style.left='50%';
  joyStick.style.top='50%';
  joyStick.style.transform='translate(-50%,-50%)';
  stickArrow.style.opacity='0.3';
  stickArrow.style.transform='rotate(0deg)';
  joy.dx=0;joy.dy=0;joy.moving=false;_joyTid=null;
}

joyZone.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  _joyTid=t.identifier;
  _joySet(t.clientX,t.clientY);
},{passive:false});
joyZone.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(const t of e.changedTouches){if(t.identifier===_joyTid)_joySet(t.clientX,t.clientY);}
},{passive:false});
joyZone.addEventListener('touchend',e=>{
  e.preventDefault();
  for(const t of e.changedTouches){if(t.identifier===_joyTid)_joyReset();}
},{passive:false});
joyZone.addEventListener('touchcancel',()=>_joyReset());
// Mouse fallback for testing
let _joyMD=false;
joyZone.addEventListener('mousedown',e=>{_joyMD=true;_joySet(e.clientX,e.clientY);e.preventDefault();});
window.addEventListener('mousemove',e=>{if(_joyMD)_joySet(e.clientX,e.clientY);});
window.addEventListener('mouseup',()=>{if(_joyMD){_joyMD=false;_joyReset();}});

// â”€â”€ Mobile action buttons â”€â”€
let mobileShoot=false;
const mobShoot=document.getElementById('mob-shoot');
mobShoot.addEventListener('touchstart',e=>{e.preventDefault();mobileShoot=true;},{passive:false});
mobShoot.addEventListener('touchend',e=>{e.preventDefault();mobileShoot=false;},{passive:false});
mobShoot.addEventListener('mousedown',()=>mobileShoot=true);
mobShoot.addEventListener('mouseup',()=>mobileShoot=false);

document.getElementById('mob-spell1').addEventListener('touchstart',e=>{e.preventDefault();G.castSpell(0);},{passive:false});
document.getElementById('mob-spell1').addEventListener('click',()=>G.castSpell(0));
document.getElementById('mob-spell2').addEventListener('touchstart',e=>{e.preventDefault();G.castSpell(2);},{passive:false});
document.getElementById('mob-spell2').addEventListener('click',()=>G.castSpell(2));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETWORK (PeerJS) - FIXED RELIABLE SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let peer=null, conn=null, isHost=false, isMulti=false;

function makeCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:4},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function mkPeer(id){
  return new Promise((res,rej)=>{
    const p=new Peer(id,{
      // Use reliable connection with JSON serialization
      config:{iceServers:[
        {urls:'stun:stun.l.google.com:19302'},
        {urls:'stun:stun1.l.google.com:19302'},
      ]},
    });
    p.on('open',()=>res(p));
    p.on('error',rej);
    setTimeout(()=>rej(new Error('ì—°ê²° íƒ€ì„ì•„ì›ƒ')),15000);
  });
}

// â”€â”€ Message handler â”€â”€
function onData(raw){
  let d;
  try{d=(typeof raw==='string')?JSON.parse(raw):raw;}
  catch(e){return;}

  switch(d.t){
    // Full remote state (position, hp, mana, creatures)
    case 's':
      if(!G.remote) return;
      // Interpolate position for smoother movement
      G.remote._tx=d.x; G.remote._ty=d.y;
      G.remote.facing=d.f;
      G.remote.hp=d.hp;
      G.remote.mana=d.mn;
      G.remote.basicCdPct=d.bcd||0;
      // Rebuild remote creatures from serialized data
      // Keep existing creature objects to avoid flicker; update their positions
      const newCrs=d.cr||[];
      if(newCrs.length===0){
        G.remote.creatures=[];
      } else {
        // Match by index - creatures synced by array position
        const updated=[];
        newCrs.forEach((c,i)=>{
          let existing=G.remote.creatures[i];
          const def=CREATURE_DEFS[c.i];
          if(!def) return;
          if(!existing||existing.id!==c.i){
            existing=new Creature(def,G.remote.side,c.x,c.y);
          }
          // Smooth creature position interpolation
          existing._tx=c.x; existing._ty=c.y;
          existing.currentHp=c.h;
          updated.push(existing);
        });
        G.remote.creatures=updated;
      }
      break;

    // Projectile fired by remote - authoritative spawn
    case 'p':
      G.projectiles.push(new Projectile({
        x:d.x,y:d.y,vx:d.vx,vy:d.vy,
        dmg:d.dm,size:d.sz,color:d.cl,
        owner:G.remote?G.remote.side:'enemy',
        fromNet:true, // mark so we don't double-process
      }));
      break;

    // Orb spawn sync (hostâ†’guest)
    case 'o':
      if(!isHost) G.orbs.push(new ManaOrb(d.seed));
      break;

    // Orb picked up by remote (hostâ†’guest or guestâ†’host)
    case 'ob':
      if(d.i!==undefined) G.orbs.splice(d.i,1);
      break;

    // Round result
    case 'r':
      G._onRemoteRound(d.win);
      break;

    // Heal effect (remote used heal spell)
    case 'h':
      if(G.remote){
        G.remote.hp=d.hp;
        G.particles.push(new Particle(G.remote.x,G.remote.y,'#34d399',14));
      }
      break;

    // Ping/pong for connection check
    case 'ping':
      netSend({t:'pong'});
      break;
  }
}

function netSend(obj){
  if(conn&&conn.open){
    try{conn.send(JSON.stringify(obj));}
    catch(e){console.warn('send err',e);}
  }
}

function setupConn(c){
  conn=c;
  conn.on('data',onData);
  conn.on('close',()=>{
    if(G.state==='playing'){
      alert('ìƒëŒ€ë°© ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.');
      location.reload();
    }
  });
  conn.on('error',err=>console.warn('conn err',err));
}

// â”€â”€ Create room â”€â”€
document.getElementById('createRoomBtn').addEventListener('click',async()=>{
  const code=makeCode();
  const btn=document.getElementById('createRoomBtn');
  btn.disabled=true;btn.textContent='ìƒì„± ì¤‘...';
  try{
    peer=await mkPeer('spellarena-'+code);
    isHost=true;
    document.getElementById('myRoomCode').style.display='block';
    document.getElementById('roomCodeDisplay').textContent=code;
    setHostStatus('ì¹œêµ¬ê°€ ì ‘ì†í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...','');
    peer.on('connection',c=>{
      // Use RELIABLE connection for game state
      setupConn(c);
      setHostStatus('âœ… ì—°ê²°ë¨! ì ì‹œ í›„ ì‹œì‘...','ok');
      setTimeout(()=>beginMulti(),1000);
    });
  }catch(err){
    setHostStatus('âŒ '+err.message,'err');
    btn.disabled=false;btn.textContent='ë°© ìƒì„±í•˜ê¸°';
  }
});
function setHostStatus(msg,cls){
  const el=document.getElementById('hostStatus');
  el.textContent=msg;el.className='status-text'+(cls?' '+cls:'');
}

// â”€â”€ Join room â”€â”€
document.getElementById('joinRoomBtn').addEventListener('click',async()=>{
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if(code.length!==4){setJoinStatus('4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”','err');return;}
  const btn=document.getElementById('joinRoomBtn');
  btn.disabled=true;setJoinStatus('ì—°ê²° ì¤‘...','');
  try{
    peer=await mkPeer('spellarena-guest-'+Math.random().toString(36).slice(2,7));
    isHost=false;
    // CRITICAL FIX: reliable:true, serialization:'json' for consistent data delivery
    const c=peer.connect('spellarena-'+code,{
      reliable:true,
      serialization:'json',
    });
    c.on('open',()=>{
      setupConn(c);
      setJoinStatus('âœ… ì—°ê²°ë¨! ì ì‹œ í›„ ì‹œì‘...','ok');
      setTimeout(()=>beginMulti(),1000);
    });
    c.on('error',()=>{setJoinStatus('âŒ ì—°ê²° ì‹¤íŒ¨','err');btn.disabled=false;});
    setTimeout(()=>{
      if(!c.open){setJoinStatus('âŒ ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ','err');btn.disabled=false;}
    },8000);
  }catch(err){
    setJoinStatus('âŒ '+err.message,'err');btn.disabled=false;
  }
});
function setJoinStatus(msg,cls){
  const el=document.getElementById('joinStatus');
  el.textContent=msg;el.className='status-text'+(cls?' '+cls:'');
}

function beginMulti(){
  isMulti=true;
  G.roundNum=1;G.playerWins=0;G.enemyWins=0;
  G.startRound();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENTITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Particle{
  constructor(x,y,color,n=8){
    this.dead=false;this._p=[];
    for(let i=0;i<n;i++){
      const a=rnd(0,Math.PI*2),s=rnd(1.5,4.5);
      this._p.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,color});
    }
  }
  update(){
    this._p.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.87;p.vy*=.87;p.life-=.042;});
    this._p=this._p.filter(p=>p.life>0);
    if(!this._p.length) this.dead=true;
  }
  draw(c){
    this._p.forEach(p=>{
      c.globalAlpha=Math.max(0,p.life);c.fillStyle=p.color;
      c.beginPath();c.arc(p.x,p.y,3.5*p.life,0,Math.PI*2);c.fill();
    });
    c.globalAlpha=1;
  }
}

class Projectile{
  constructor({x,y,vx,vy,dmg,size,color,owner,fromNet}){
    Object.assign(this,{x,y,vx,vy,dmg,size,color,owner,fromNet:fromNet||false,dead:false});
    this._trail=[];
  }
  update(){
    this._trail.unshift({x:this.x,y:this.y});
    if(this._trail.length>5) this._trail.pop();
    this.x+=this.vx;this.y+=this.vy;
    if(this.x<-20||this.x>CFG.W+20||this.y<-20||this.y>CFG.H+20) this.dead=true;
  }
  draw(c){
    this._trail.forEach((t,i)=>{
      c.globalAlpha=(1-i/this._trail.length)*.4;
      c.fillStyle=this.color;c.beginPath();
      c.arc(t.x,t.y,this.size*(1-i*.18),0,Math.PI*2);c.fill();
    });
    c.globalAlpha=1;c.fillStyle=this.color;
    c.shadowBlur=18;c.shadowColor=this.color;
    c.beginPath();c.arc(this.x,this.y,this.size,0,Math.PI*2);c.fill();
    c.shadowBlur=0;
  }
}

class ManaOrb{
  constructor(seed){
    const r=(seed!==undefined)?seed:Math.random();
    if(r<.3){this.x=rnd(40,CFG.MID-80);this.bonus=1;}
    else if(r<.7){this.x=rnd(CFG.MID-90,CFG.MID+90);this.bonus=1;}
    else{this.x=rnd(CFG.MID+80,CFG.W-40);this.bonus=2;}
    this.y=rnd(55,CFG.H-55);this.pulse=rnd(0,Math.PI*2);
    this.dead=false;this.rich=(this.bonus>1);
  }
  update(){this.pulse+=.06;}
  draw(c){
    const r=9+Math.sin(this.pulse)*2.5;
    const g=c.createRadialGradient(this.x,this.y,1,this.x,this.y,r);
    g.addColorStop(0,this.rich?'#fef08a':'#e9d5ff');
    g.addColorStop(1,this.rich?'#f59e0b00':'#a855f700');
    c.fillStyle=g;c.shadowBlur=16;c.shadowColor=this.rich?'#f59e0b':'#a855f7';
    c.beginPath();c.arc(this.x,this.y,r,0,Math.PI*2);c.fill();c.shadowBlur=0;
    c.fillStyle=this.rich?'#fbbf24':'#d8b4fe';
    c.font='bold 9px Segoe UI';c.textAlign='center';
    c.fillText(`+${this.bonus}`,this.x,this.y+r+11);
  }
}

class Creature{
  constructor(def,owner,x,y){
    Object.assign(this,def);
    this.owner=owner;this.x=x;this.y=y;
    this._tx=x;this._ty=y; // interpolation targets
    this.currentHp=def.hp;this.dead=false;
  }
  update(target){
    if(this.shield||this.spd===0) return;
    const dx=target.x-this.x,dy=target.y-this.y,d=Math.hypot(dx,dy);
    if(d>28){this.x+=(dx/d)*this.spd;this.y+=(dy/d)*this.spd;}
    else{target.hp=Math.max(0,target.hp-this.atk);this.dead=true;}
    this._tx=this.x;this._ty=this.y;
  }
  // For remote creatures: interpolate toward received position
  interpolate(){
    const LERP=0.25;
    if(this._tx!==undefined){
      this.x+=(this._tx-this.x)*LERP;
      this.y+=(this._ty-this.y)*LERP;
    }
  }
  draw(c){
    const gc=this.owner==='player'?'#22c55e':'#f97316';
    c.fillStyle=this.color;c.shadowBlur=18;c.shadowColor=gc;
    c.beginPath();c.arc(this.x,this.y,this.size,0,Math.PI*2);c.fill();c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.7)';c.lineWidth=2.5;c.stroke();
    c.font=`bold ${this.size+7}px Arial`;c.textAlign='center';c.textBaseline='middle';
    c.fillStyle='#fff';c.fillText(this.icon,this.x,this.y);c.textBaseline='alphabetic';
    if(this.hp>1){
      const bw=this.size*2;
      c.fillStyle='rgba(0,0,0,.6)';c.fillRect(this.x-bw/2,this.y-this.size-10,bw,5);
      c.fillStyle='#a855f7';c.fillRect(this.x-bw/2,this.y-this.size-10,bw*(this.currentHp/this.hp),5);
    }
  }
}

class Character{
  constructor({x,y,color,label,facing,side}){
    this.x=x;this.y=y;this.color=color;this.label=label;
    this.facing=facing;
    this.side=side;
    this._tx=x;this._ty=y; // interpolation targets for remote
    this.hp=CFG.MAX_HP;this.maxHp=CFG.MAX_HP;
    this.mana=0;this.maxMana=CFG.MAX_MANA;
    this.speed=2.8;
    this.creatures=[];this.dangerTimer=0;
    this.basicCd=0;this.spellCd={};
    this.basicCdPct=0; // for remote display
  }
  isInDanger(){
    if(this.side==='player') return this.x>CFG.MID+40;
    return this.x>CFG.MID+40;
  }
  updateDanger(dt){
    if(this.isInDanger()){
      this.dangerTimer+=dt;
      if(this.dangerTimer>CFG.DANGER_GRACE)
        this.hp=Math.max(0,this.hp-CFG.DANGER_DPS*(dt/1000));
    } else {
      this.dangerTimer=Math.max(0,this.dangerTimer-dt*2);
    }
  }
  // Smooth interpolation toward networked target position
  interpolate(){
    const LERP=0.3; // how fast to catch up (0=instant, 1=never)
    this.x+=(this._tx-this.x)*LERP;
    this.y+=(this._ty-this.y)*LERP;
  }
  // Serialize for network - compact format
  toNet(now){
    return{
      x:Math.round(this.x),
      y:Math.round(this.y),
      f:this.facing,
      hp:Math.round(this.hp*10)/10,
      mn:Math.round(this.mana*10)/10,
      bcd:this.basicCd>0?Math.round(this.basicCd):0,
      cr:this.creatures.map(c=>({
        i:c.id,
        x:Math.round(c.x),
        y:Math.round(c.y),
        h:c.currentHp,
      })),
    };
  }
  draw(c){
    const T=Date.now();
    const{x,y,color,facing,side}=this;
    const isMoving=(side==='player')
      ?(joy.moving||keys['ArrowLeft']||keys['ArrowRight']||keys['ArrowUp']||keys['ArrowDown']||keys['KeyA']||keys['KeyD']||keys['KeyW']||keys['KeyS'])
      :true;
    const leg=isMoving?Math.sin(T*.012)*11:0;
    const arm=isMoving?Math.sin(T*.012)*9:0;
    const dir=facing==='right'?1:-1;
    // Shadow
    c.fillStyle='rgba(0,0,0,.28)';c.beginPath();c.ellipse(x,y+34,24,8,0,0,Math.PI*2);c.fill();
    // Legs
    c.strokeStyle=color+'aa';c.lineWidth=12;c.lineCap='round';
    c.beginPath();c.moveTo(x-7,y+20);c.lineTo(x-7,y+36+leg);c.stroke();
    c.beginPath();c.moveTo(x+7,y+20);c.lineTo(x+7,y+36-leg);c.stroke();
    // Body
    const bg=c.createLinearGradient(x-16,y-14,x+16,y+24);
    bg.addColorStop(0,color);bg.addColorStop(1,color+'88');
    c.fillStyle=bg;c.shadowBlur=10;c.shadowColor=color+'60';
    c.fillRect(x-16,y-14,32,38);c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.65)';c.lineWidth=2;c.strokeRect(x-16,y-14,32,38);
    c.fillStyle='rgba(255,255,255,.1)';c.fillRect(x-11,y-10,22,10);
    // Arms
    c.strokeStyle=color;c.lineWidth=10;
    c.beginPath();c.moveTo(x-16,y-4);c.lineTo(x-26*dir,y+12+arm);c.stroke();
    c.beginPath();c.moveTo(x+16,y-4);c.lineTo(x+28*dir,y+10-arm);c.stroke();
    // Head
    c.fillStyle='#fbbf24';c.shadowBlur=7;c.shadowColor='#fbbf2450';
    c.beginPath();c.arc(x,y-28,17,0,Math.PI*2);c.fill();c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.75)';c.lineWidth=2;c.stroke();
    const ex=dir*5;
    c.fillStyle='#111';c.fillRect(x+ex-4,y-32,4,4);c.fillRect(x+ex+4,y-32,4,4);
    c.strokeStyle='#333';c.lineWidth=2;c.beginPath();c.arc(x+ex,y-24,4,0,Math.PI);c.stroke();
    // Weapon
    c.fillStyle='#fbbf24';c.shadowBlur=9;c.shadowColor='#f59e0b';
    c.fillRect(x+22*dir,y-22,7,36);c.shadowBlur=0;
    c.fillStyle='#f59e0b';c.fillRect(x+20*dir,y-26,11,9);
    // HP bar
    const hp=this.hp/this.maxHp;
    c.fillStyle='rgba(0,0,0,.7)';c.fillRect(x-34,y-52,68,9);
    const hbg=c.createLinearGradient(x-34,0,x+34,0);
    if(side==='player'){hbg.addColorStop(0,'#10b981');hbg.addColorStop(1,'#34d399');}
    else{hbg.addColorStop(0,'#ef4444');hbg.addColorStop(1,'#f87171');}
    c.fillStyle=hbg;c.fillRect(x-34,y-52,68*hp,9);
    c.strokeStyle='rgba(255,255,255,.25)';c.lineWidth=1;c.strokeRect(x-34,y-52,68,9);
    // Name
    c.font='bold 12px Segoe UI';c.textAlign='center';
    c.strokeStyle='#000';c.lineWidth=3.5;c.strokeText(this.label,x,y-64);
    c.fillStyle=color;c.fillText(this.label,x,y-64);
    // Danger ring
    if(this.dangerTimer>CFG.DANGER_GRACE){
      const a=.5+Math.sin(T*.012)*.4;
      c.strokeStyle=`rgba(239,68,68,${a})`;c.lineWidth=3;
      c.shadowBlur=12;c.shadowColor='#ef4444';
      c.beginPath();c.arc(x,y,42,0,Math.PI*2);c.stroke();c.shadowBlur=0;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI CONTROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class AICtrl{
  constructor(e,p){
    this.e=e;this.p=p;
    this.target={x:e.x,y:e.y};
    this.nextMove=0;this.spellT=0;this.creatureT=0;
  }
  tick(now,orbs,projs){
    const e=this.e,p=this.p;
    if(now>this.nextMove){
      this.nextMove=now+rnd(600,1400);
      if(e.hp<e.maxHp*.35)
        this.target={x:rnd(CFG.MID+60,CFG.W-60),y:rnd(80,CFG.H-80)};
      else if(e.mana<4){
        const rich=orbs.filter(o=>o.rich).sort((a,b)=>dist(e,a)-dist(e,b))[0];
        const own=orbs.filter(o=>o.x>CFG.MID).sort((a,b)=>dist(e,a)-dist(e,b))[0];
        const pick=rich||own;
        if(pick) this.target={x:pick.x,y:pick.y};
        else this.target={x:rnd(CFG.MID+20,CFG.W-50),y:rnd(80,CFG.H-80)};
      } else {
        const o=orbs.filter(o=>o.x>CFG.MID).sort((a,b)=>dist(e,a)-dist(e,b))[0];
        if(o) this.target={x:o.x,y:o.y};
        else this.target={x:rnd(CFG.MID+30,CFG.W-50),y:rnd(80,CFG.H-80)};
      }
    }
    const dx=this.target.x-e.x,dy=this.target.y-e.y,d=Math.hypot(dx,dy);
    if(d>6){e.x+=(dx/d)*e.speed;e.y+=(dy/d)*e.speed;}
    e.x=clamp(e.x,28,CFG.W-28);e.y=clamp(e.y,55,CFG.H-28);
    e.facing=e.x<p.x?'right':'left';
    if(now>this.spellT&&e.mana>=2){
      const def=(e.hp<e.maxHp*.5)?SPELL_DEFS[1]:(Math.random()<.55?SPELL_DEFS[0]:SPELL_DEFS[2]);
      if(e.mana>=def.cost){
        if(def.type==='heal'){e.hp=Math.min(e.maxHp,e.hp+def.heal);}
        else{
          const ang=Math.atan2(p.y-e.y,p.x-e.x);
          projs.push(new Projectile({x:e.x-28,y:e.y-8,vx:Math.cos(ang)*def.spd,vy:Math.sin(ang)*def.spd,dmg:def.dmg,size:def.size,color:def.color,owner:'enemy'}));
        }
        e.mana-=def.cost;
        this.spellT=now+rnd(1000,2000);
      }
    }
    if(now>this.creatureT&&e.mana>=2&&e.creatures.length<5){
      const def=CREATURE_DEFS[Math.floor(Math.random()*CREATURE_DEFS.length)];
      if(e.mana>=def.cost){
        e.creatures.push(new Creature(def,'enemy',e.x-50,e.y+rnd(-50,50)));
        e.mana-=def.cost;this.creatureT=now+rnd(1500,3000);
      }
    }
    e.basicCd-=16;
    if(e.basicCd<=0&&Math.random()<.013){
      const dir=e.facing==='right'?1:-1;
      projs.push(new Projectile({x:e.x+dir*28,y:e.y-8,vx:dir*6.5,vy:rnd(-.4,.4),dmg:CFG.BASIC_DMG,size:7,color:'#fb923c',owner:'enemy'}));
      e.basicCd=CFG.BASIC_CD;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G={
  state:'menu',
  roundNum:1,playerWins:0,enemyWins:0,
  player:null,enemy:null,remote:null,
  projectiles:[],orbs:[],particles:[],
  ai:null,
  _ivals:{},_lastT:0,

  buildButtons(){
    const sp=document.getElementById('spellPanel');
    const cp=document.getElementById('creaturePanel');
    sp.querySelectorAll('.action-btn').forEach(b=>b.remove());
    cp.querySelectorAll('.action-btn').forEach(b=>b.remove());
    SPELL_DEFS.forEach((def,i)=>{
      const btn=document.createElement('button');
      btn.className='action-btn spell';btn.id=`spb${i}`;
      btn.innerHTML=`<span class="key">${i+1}</span>${def.icon}<span class="cost">ğŸ’§${def.cost}</span>`;
      btn.addEventListener('pointerdown',e=>{e.preventDefault();G.castSpell(i);});
      const cd=document.createElement('div');cd.className='cd-mask';cd.id=`spc${i}`;cd.style.display='none';
      btn.appendChild(cd);sp.appendChild(btn);
    });
    ['Q','W','E','R'].forEach((k,i)=>{
      const def=CREATURE_DEFS[i];
      const btn=document.createElement('button');
      btn.className='action-btn creature';btn.id=`crb${i}`;
      btn.innerHTML=`<span class="key">${k}</span>${def.icon}<span class="cost">ğŸ’§${def.cost}</span>`;
      btn.addEventListener('pointerdown',e=>{e.preventDefault();G.summon(i);});
      cp.appendChild(btn);
    });
  },

  _clearIvals(){
    Object.values(this._ivals).forEach(clearInterval);
    this._ivals={};
  },

  startRound(){
    this.projectiles=[];this.orbs=[];this.particles=[];
    this._clearIvals();

    const playerX=(!isMulti||isHost)?160:CFG.W-160;
    const playerFacing=(!isMulti||isHost)?'right':'left';
    this.player=new Character({x:playerX,y:CFG.H/2,color:'#60a5fa',label:'ë‚˜',facing:playerFacing,side:'player'});

    if(isMulti){
      const remX=isHost?CFG.W-160:160;
      const remF=isHost?'left':'right';
      this.remote=new Character({x:remX,y:CFG.H/2,color:'#f87171',label:'ìƒëŒ€',facing:remF,side:'enemy'});
      this.remote._tx=remX;this.remote._ty=CFG.H/2;
      this.enemy=this.remote;
      this.ai=null;
    } else {
      this.enemy=new Character({x:CFG.W-160,y:CFG.H/2,color:'#f87171',label:'AI',facing:'left',side:'enemy'});
      this.remote=null;
      this.ai=new AICtrl(this.enemy,this.player);
    }

    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('overlayScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    resizeCanvas();
    applyMobileUI();

    // Timer
    let sec=0;
    this._ivals.timer=setInterval(()=>{
      sec++;
      const m=Math.floor(sec/60),s=sec%60;
      document.getElementById('timer').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    },1000);

    // Orbs: only host spawns
    const spawnOrb=()=>{
      if(this.state!=='playing'||this.orbs.length>=CFG.MAX_ORBS) return;
      const seed=Math.random();
      if(isMulti&&isHost) netSend({t:'o',seed});
      if(!isMulti||isHost) this.orbs.push(new ManaOrb(seed));
    };
    for(let i=0;i<3;i++) spawnOrb();
    this._ivals.orb=setInterval(spawnOrb,CFG.ORB_INTERVAL);

    // Mana regen
    this._ivals.regen=setInterval(()=>{
      if(this.state!=='playing') return;
      this.player.mana=Math.min(CFG.MAX_MANA,this.player.mana+CFG.MANA_REGEN);
      if(!isMulti) this.enemy.mana=Math.min(CFG.MAX_MANA,this.enemy.mana+CFG.MANA_REGEN);
      this.updateHUD();
    },1000);

    // NETWORK STATE BROADCAST at 30hz
    if(isMulti){
      this._ivals.net=setInterval(()=>{
        if(this.state!=='playing'||!this.player) return;
        // Send full state snapshot
        netSend({t:'s',...this.player.toNet(performance.now())});
      },1000/CFG.NET_HZ);

      // Keepalive ping
      this._ivals.ping=setInterval(()=>{
        netSend({t:'ping'});
      },3000);
    }

    this.updateRoundHUD();
    this.state='playing';
    this._lastT=performance.now();
    requestAnimationFrame(t=>this._loop(t));
  },

  castSpell(i){
    if(this.state!=='playing') return;
    const def=SPELL_DEFS[i],p=this.player,now=performance.now();
    if(!def||p.mana<def.cost) return;
    if(p.spellCd[i]&&now<p.spellCd[i]) return;
    if(def.type==='proj'){
      const dir=p.facing==='right'?1:-1;
      const pj=new Projectile({
        x:p.x+dir*30,y:p.y-8,
        vx:dir*def.spd,vy:0,
        dmg:def.dmg,size:def.size,color:def.color,
        owner:'player',
      });
      this.projectiles.push(pj);
      // Send projectile to remote - use short key names to save bandwidth
      if(isMulti) netSend({t:'p',x:pj.x,y:pj.y,vx:pj.vx,vy:pj.vy,dm:pj.dmg,sz:pj.size,cl:pj.color});
      p.mana-=def.cost;
    } else if(def.type==='heal'){
      p.hp=Math.min(p.maxHp,p.hp+def.heal);
      this.particles.push(new Particle(p.x,p.y,'#34d399',14));
      p.mana-=def.cost;
      if(isMulti) netSend({t:'h',hp:p.hp}); // sync HP after heal
    }
    p.spellCd[i]=now+def.cd;
    this.updateHUD();
  },

  summon(i){
    if(this.state!=='playing') return;
    const def=CREATURE_DEFS[i],p=this.player;
    if(!def||p.mana<def.cost||p.creatures.length>=8) return;
    const cx=p.x+(p.facing==='right'?52:-52),cy=p.y+rnd(-60,60);
    p.creatures.push(new Creature(def,'player',cx,cy));
    p.mana-=def.cost;
    this.updateHUD();
    // Creature state is synced via full state broadcast
  },

  _onRemoteRound(remoteWon){
    if(this.state!=='playing') return;
    if(remoteWon) this.enemyWins++;
    else this.playerWins++;
    this.state='roundOver';
    this._clearIvals();
    setTimeout(()=>this.showResult(!remoteWon),400);
  },

  _loop(t){
    if(this.state!=='playing') return;
    const dt=Math.min(50,t-this._lastT);this._lastT=t;
    this._update(dt,t);
    this._render();
    requestAnimationFrame(ts=>this._loop(ts));
  },

  _update(dt,now){
    const p=this.player,e=this.enemy;

    // â”€â”€ Player movement
    let dx=0,dy=0;
    if(joy.moving){dx=joy.dx;dy=joy.dy;}
    else{
      if(keys['ArrowLeft']||keys['KeyA'])  dx-=1;
      if(keys['ArrowRight']||keys['KeyD']) dx+=1;
      if(keys['ArrowUp']||keys['KeyW'])    dy-=1;
      if(keys['ArrowDown']||keys['KeyS'])  dy+=1;
      if(dx&&dy){dx*=.707;dy*=.707;}
    }
    if(dx>0) p.facing='right';
    else if(dx<0) p.facing='left';
    p.x=clamp(p.x+dx*p.speed,28,CFG.W-28);
    p.y=clamp(p.y+dy*p.speed,55,CFG.H-28);

    // â”€â”€ Remote interpolation (smooth movement)
    if(isMulti&&this.remote){
      this.remote.interpolate();
      // Interpolate remote creatures too
      this.remote.creatures.forEach(c=>c.interpolate());
    }

    // â”€â”€ Danger zones
    p.updateDanger(dt);
    if(!isMulti) e.updateDanger(dt);

    // â”€â”€ Player basic shot
    p.basicCd-=dt;
    if(p.basicCd<=0&&(keys['Space']||mobileShoot)){
      const dir=p.facing==='right'?1:-1;
      const pj=new Projectile({
        x:p.x+dir*28,y:p.y-8,
        vx:dir*6.5,vy:rnd(-.4,.4),
        dmg:CFG.BASIC_DMG,size:7,color:'#93c5fd',
        owner:'player',
      });
      this.projectiles.push(pj);
      if(isMulti) netSend({t:'p',x:pj.x,y:pj.y,vx:pj.vx,vy:pj.vy,dm:pj.dmg,sz:pj.size,cl:pj.color});
      p.basicCd=CFG.BASIC_CD;
    }

    // â”€â”€ AI
    if(this.ai) this.ai.tick(now,this.orbs,this.projectiles);

    // â”€â”€ Orbs pickup
    for(let i=this.orbs.length-1;i>=0;i--){
      const o=this.orbs[i];o.update();
      if(dist(p,o)<22){
        p.mana=Math.min(CFG.MAX_MANA,p.mana+o.bonus);
        this.particles.push(new Particle(o.x,o.y,o.rich?'#fbbf24':'#a855f7',12));
        // Notify remote which orb was picked
        if(isMulti) netSend({t:'ob',i});
        this.orbs.splice(i,1);
      } else if(!isMulti&&dist(e,o)<22){
        e.mana=Math.min(CFG.MAX_MANA,e.mana+o.bonus);
        this.orbs.splice(i,1);
      }
    }

    // â”€â”€ Projectile collision
    for(let i=this.projectiles.length-1;i>=0;i--){
      const pj=this.projectiles[i];pj.update();
      if(pj.dead){this.projectiles.splice(i,1);continue;}

      let hit=false;
      const hurtEnemy=(pj.owner==='player');
      const hurtPlayer=(pj.owner==='enemy');

      if(hurtEnemy){
        if(dist(pj,e)<32){
          e.hp=Math.max(0,e.hp-pj.dmg);
          this.particles.push(new Particle(pj.x,pj.y,pj.color,8));
          pj.dead=true;hit=true;
        } else {
          for(let j=e.creatures.length-1;j>=0&&!hit;j--){
            const cr=e.creatures[j];
            if(dist(pj,cr)<cr.size+pj.size){
              this.particles.push(new Particle(cr.x,cr.y,cr.color,10));
              if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)e.creatures.splice(j,1);}
              else e.creatures.splice(j,1);
              pj.dead=true;hit=true;
            }
          }
        }
      }
      if(!hit&&hurtPlayer){
        if(dist(pj,p)<32){
          p.hp=Math.max(0,p.hp-pj.dmg);
          this.particles.push(new Particle(pj.x,pj.y,pj.color,8));
          pj.dead=true;hit=true;
        } else {
          for(let j=p.creatures.length-1;j>=0&&!hit;j--){
            const cr=p.creatures[j];
            if(dist(pj,cr)<cr.size+pj.size){
              this.particles.push(new Particle(cr.x,cr.y,cr.color,10));
              if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)p.creatures.splice(j,1);}
              else p.creatures.splice(j,1);
              pj.dead=true;hit=true;
            }
          }
        }
      }
      if(pj.dead) this.projectiles.splice(i,1);
    }

    // â”€â”€ Local creature movement
    // Solo: move AI creatures toward player
    if(!isMulti){
      e.creatures.forEach(c=>{c.update(p);if(c.dead)this.particles.push(new Particle(c.x,c.y,'#facc15',14));});
      e.creatures=e.creatures.filter(c=>!c.dead);
    }
    // Player creatures always move locally
    p.creatures.forEach(c=>{c.update(e);if(c.dead)this.particles.push(new Particle(c.x,c.y,'#facc15',14));});
    p.creatures=p.creatures.filter(c=>!c.dead);

    // â”€â”€ Particles
    this.particles.forEach(pt=>pt.update());
    this.particles=this.particles.filter(pt=>!pt.dead);

    this.updateHUD();

    // â”€â”€ Win check
    if(this.state==='playing'&&(p.hp<=0||e.hp<=0)){
      const won=p.hp>0;
      if(won) this.playerWins++; else this.enemyWins++;
      this.state='roundOver';
      this._clearIvals();
      if(isMulti) netSend({t:'r',win:!won});
      setTimeout(()=>this.showResult(won),400);
    }
  },

  _render(){
    const c=ctx;
    const bg=c.createLinearGradient(0,0,CFG.W,CFG.H);
    bg.addColorStop(0,'#0d0b1a');bg.addColorStop(.5,'#14102a');bg.addColorStop(1,'#1a0f38');
    c.fillStyle=bg;c.fillRect(0,0,CFG.W,CFG.H);
    // Stars
    const T=Date.now();
    for(let i=0;i<60;i++){
      c.globalAlpha=(Math.sin(T*.0008+i)*.4+.6)*.4;c.fillStyle='#fff';
      c.fillRect((i*157+13)%CFG.W,(i*211+7)%CFG.H,(i%2)+1,(i%2)+1);
    }
    c.globalAlpha=1;
    // Zone tints
    const pDanger=this.player.isInDanger()&&this.player.dangerTimer>CFG.DANGER_GRACE;
    c.fillStyle=`rgba(239,68,68,${pDanger?.1:.04})`;c.fillRect(CFG.MID,0,CFG.MID,CFG.H);
    c.fillStyle='rgba(59,130,246,.04)';c.fillRect(0,0,CFG.MID,CFG.H);
    // Labels
    c.font='bold 10px Segoe UI';c.textAlign='center';
    c.fillStyle='rgba(148,163,184,.22)';
    c.fillText('ë‚´ êµ¬ì—­',CFG.MID/2,17);c.fillText('ì  êµ¬ì—­',CFG.MID+CFG.MID/2,17);
    c.fillStyle='rgba(251,191,36,.14)';c.fillText('+2 ìœ„í—˜ / 1ì´ˆ í›„ ë°ë¯¸ì§€',CFG.MID+CFG.MID/2,29);
    // Center line
    c.strokeStyle='#a855f7';c.lineWidth=3;c.setLineDash([14,12]);
    c.shadowBlur=14;c.shadowColor='#a855f780';
    c.beginPath();c.moveTo(CFG.MID,0);c.lineTo(CFG.MID,CFG.H);c.stroke();
    c.setLineDash([]);c.shadowBlur=0;
    // Danger warning
    const p=this.player;
    if(p.isInDanger()&&p.dangerTimer>0){
      c.font='bold 12px Segoe UI';c.textAlign='center';
      if(p.dangerTimer<CFG.DANGER_GRACE){
        c.fillStyle='rgba(251,191,36,.9)';
        c.fillText(`âš ï¸ ${((CFG.DANGER_GRACE-p.dangerTimer)/1000).toFixed(1)}s`,p.x,p.y-72);
      } else {
        c.fillStyle='rgba(239,68,68,.95)';
        c.fillText('ğŸ”¥ ë°ë¯¸ì§€!',p.x,p.y-72);
      }
    }
    // Entities
    this.orbs.forEach(o=>o.draw(c));
    this.projectiles.forEach(pj=>pj.draw(c));
    this.player.creatures.forEach(cr=>cr.draw(c));
    this.enemy.creatures.forEach(cr=>cr.draw(c));
    this.particles.forEach(pt=>pt.draw(c));
    this.enemy.draw(c);
    this.player.draw(c);

    // Multiplayer connection indicator
    if(isMulti){
      const connOk=conn&&conn.open;
      c.fillStyle=connOk?'rgba(52,211,153,.8)':'rgba(248,113,113,.8)';
      c.font='bold 9px Segoe UI';c.textAlign='right';
      c.fillText(connOk?'â— ì—°ê²°ë¨':'â— ì—°ê²° ëŠê¹€',CFG.W-8,14);
    }
  },

  updateHUD(){
    if(!this.player||!this.enemy) return;
    const p=this.player,e=this.enemy;
    const ph=Math.max(0,p.hp),eh=Math.max(0,e.hp);
    document.getElementById('p-hp').style.width=(ph/p.maxHp*100)+'%';
    document.getElementById('p-hp').className='hud-fill hp'+(ph/p.maxHp<.3?' low':'');
    document.getElementById('p-hp-v').textContent=Math.ceil(ph);
    document.getElementById('p-mp').style.width=(p.mana/p.maxMana*100)+'%';
    document.getElementById('p-mp-v').textContent=Math.floor(p.mana);
    document.getElementById('e-hp').style.width=(eh/e.maxHp*100)+'%';
    document.getElementById('e-hp-v').textContent=Math.ceil(eh);
    document.getElementById('e-mp').style.width=(e.mana/e.maxMana*100)+'%';
    document.getElementById('e-mp-v').textContent=Math.floor(e.mana);
    const now=performance.now();
    SPELL_DEFS.forEach((_,i)=>{
      const btn=document.getElementById(`spb${i}`),cd=document.getElementById(`spc${i}`);
      if(!btn||!cd) return;
      const rem=(p.spellCd[i]||0)-now;
      if(rem>0){cd.style.display='flex';cd.textContent=(rem/1000).toFixed(1)+'s';}
      else cd.style.display='none';
      btn.disabled=p.mana<SPELL_DEFS[i].cost;
    });
    CREATURE_DEFS.forEach((_,i)=>{
      const btn=document.getElementById(`crb${i}`);
      if(btn) btn.disabled=p.mana<CREATURE_DEFS[i].cost||p.creatures.length>=8;
    });
  },

  updateRoundHUD(){
    document.getElementById('round-info').textContent=`ROUND ${this.roundNum}`;
    ['pip0','pip1','pip2','pip3'].forEach((id,i)=>{
      const el=document.getElementById(id);if(!el) return;
      el.className='pip';
      const total=this.playerWins+this.enemyWins;
      if(i<total) el.classList.add(i<this.playerWins?'p':'e');
    });
  },

  showResult(playerWon){
    const over=document.getElementById('overlayScreen');
    const title=document.getElementById('overlay-title');
    const sub=document.getElementById('overlay-sub');
    const next=document.getElementById('overlay-next');
    over.classList.remove('hidden');
    const gameOver=this.playerWins>=2||this.enemyWins>=2;
    if(gameOver){
      title.textContent=this.playerWins>=2?'ğŸ‰ ìµœì¢… ìŠ¹ë¦¬!':'ğŸ’€ ìµœì¢… íŒ¨ë°°';
      title.style.color=this.playerWins>=2?'#34d399':'#f87171';
      sub.textContent=`${this.playerWins} : ${this.enemyWins} â€” 3ì „ 2ì„ ìŠ¹`;
      next.textContent='ë‹¤ì‹œ í”Œë ˆì´';
      next.onclick=()=>{
        this.playerWins=0;this.enemyWins=0;this.roundNum=1;
        over.classList.add('hidden');this.startRound();
      };
    } else {
      title.textContent=playerWon?`ğŸ† ë¼ìš´ë“œ ${this.roundNum} ìŠ¹ë¦¬!`:`ğŸ’” ë¼ìš´ë“œ ${this.roundNum} íŒ¨ë°°`;
      title.style.color=playerWon?'#34d399':'#f87171';
      sub.textContent=`ì „ì  ${this.playerWins} : ${this.enemyWins}`;
      next.textContent='ë‹¤ìŒ ë¼ìš´ë“œ';this.roundNum++;
      next.onclick=()=>{over.classList.add('hidden');this.updateRoundHUD();this.startRound();};
    }
    document.getElementById('overlay-quit').onclick=()=>{
      this._clearIvals();
      this.playerWins=0;this.enemyWins=0;this.roundNum=1;
      if(peer){peer.destroy();peer=null;}
      conn=null;isMulti=false;isHost=false;
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('overlayScreen').classList.add('hidden');
      document.getElementById('menuScreen').classList.remove('hidden');
      this.state='menu';
    };
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
G.buildButtons();
resizeCanvas();
applyMobileUI();
document.getElementById('startSoloBtn').addEventListener('click',()=>{
  isMulti=false;G.roundNum=1;G.playerWins=0;G.enemyWins=0;G.startRound();
});
</script>
</body>
</html>
