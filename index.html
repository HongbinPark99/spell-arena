<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ìŠ¤í  ì•„ë ˆë‚˜</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:#0a0a12;font-family:'Segoe UI',sans-serif;
  overflow:hidden;touch-action:none;
  display:flex;align-items:center;justify-content:center;
  height:100dvh;width:100dvw;
}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.screen.hidden{display:none!important;}

/* â”€â”€ MENU â”€â”€ */
#menuScreen{
  background:radial-gradient(ellipse at 50% 40%,#1e1040 0%,#0a0a12 70%);
  color:white;gap:10px;text-align:center;padding:16px;overflow-y:auto;
}
#menuScreen h1{
  font-size:clamp(20px,5.5vw,44px);
  background:linear-gradient(90deg,#a855f7,#ec4899,#f59e0b);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  filter:drop-shadow(0 0 16px #a855f7aa);
}
.tagline{color:#c4b5fd;font-size:clamp(10px,1.8vw,13px);font-style:italic;}
.vs-row{font-size:clamp(28px,6vw,52px);}
.primary-btn{
  padding:9px 28px;font-size:clamp(13px,2.2vw,16px);font-weight:700;
  background:linear-gradient(135deg,#a855f7,#ec4899);color:white;
  border:none;border-radius:30px;cursor:pointer;
  box-shadow:0 5px 20px #a855f760;transition:transform .15s,box-shadow .15s;width:100%;max-width:480px;
}
.primary-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px #a855f790;}

/* â”€â”€ GAME SCREEN â”€â”€ */
#gameScreen{flex-direction:row;align-items:stretch;background:#0a0a12;}
#center-col{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

/* â”€â”€ HUD â”€â”€ */
#hud{
  display:flex;align-items:center;justify-content:space-between;
  padding:4px 6px;gap:4px;flex-shrink:0;
  background:rgba(10,10,20,.9);border-bottom:1px solid rgba(168,85,247,.18);
}
.hud-side{display:flex;align-items:center;gap:5px;flex:1;min-width:0;}
.hud-side.right{flex-direction:row-reverse;}
.hud-avatar{font-size:16px;flex-shrink:0;}
.hud-bars{display:flex;flex-direction:column;gap:3px;flex:1;min-width:0;}
.hud-bar-row{display:flex;align-items:center;gap:3px;font-size:8px;color:#e2e8f0;}
.hud-track{flex:1;height:5px;background:rgba(255,255,255,.12);border-radius:3px;overflow:hidden;min-width:20px;}
.hud-fill{height:100%;border-radius:3px;transition:width .15s;}
.hud-fill.hp{background:linear-gradient(90deg,#10b981,#34d399);}
.hud-fill.hp.low{background:linear-gradient(90deg,#ef4444,#f87171);}
.hud-fill.mp{background:linear-gradient(90deg,#6366f1,#a855f7);}
.hud-val{font-size:8px;font-weight:700;min-width:14px;}
#hud-mid{display:flex;flex-direction:column;align-items:center;gap:1px;flex-shrink:0;}
#round-info{font-size:7px;color:#c4b5fd;font-weight:700;letter-spacing:.5px;}
#timer{font-size:14px;color:#a855f7;font-weight:800;line-height:1;}

/* â”€â”€ CANVAS â”€â”€ */
#canvas-wrap{flex:1;position:relative;overflow:hidden;min-height:0;background:#0a0a12;}
#gameCanvas{display:block;touch-action:none;position:absolute;}

/* â”€â”€ OVERLAY â”€â”€ */
#overlayScreen{background:rgba(5,5,15,.92);z-index:50;gap:12px;color:white;text-align:center;padding:20px;}
#overlayScreen h2{font-size:clamp(20px,5vw,40px);}
#overlayScreen p{color:#c4b5fd;font-size:clamp(10px,2vw,14px);}
.overlay-btns{display:flex;gap:10px;justify-content:center;margin-top:6px;}
.primary-btn.ghost{background:linear-gradient(135deg,#374151,#4b5563);}

/* â”€â”€ 360Â° JOYSTICK â”€â”€ */
#joystick-zone{
  position:absolute;bottom:12px;left:50px; /* left:12px â†’ 50px */
  width:128px;height:128px;
  display:none;z-index:40;touch-action:none;user-select:none;
}
#joystick-base{
  width:100%;height:100%;border-radius:50%;
  background:rgba(168,85,247,.10);
  border:2.5px solid rgba(168,85,247,.45);
  position:relative;
  box-shadow:0 0 20px rgba(168,85,247,.15),inset 0 0 20px rgba(0,0,0,.3);
}
#joystick-stick{
  width:50px;height:50px;border-radius:50%;
  background:radial-gradient(circle at 33% 33%,#d8b4fe,#7c3aed 60%,#5b21b6);
  border:2.5px solid rgba(255,255,255,.4);
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  box-shadow:0 4px 20px #7c3aed90,0 0 8px rgba(255,255,255,.2);
  pointer-events:none;
}

/* â”€â”€ MOBILE UI â”€â”€ */
#mobile-compact-ui{
  position:absolute;bottom:20px;right:60px; /* right:20px â†’ 60px */
  display:none;flex-direction:column;gap:8px;align-items:flex-end;
  z-index:40;
}
.mob-compact-btn{
  width:48px;height:48px;border-radius:8px;
  border:2px solid rgba(255,255,255,.4);
  color:white;font-size:18px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;touch-action:none;
  box-shadow:0 2px 12px rgba(0,0,0,.6);transition:transform .1s;
}
.mob-compact-btn:active{transform:scale(.9);}

#mobile-skill-panel{
  display:none;
  position:absolute;
  bottom:70px;right:60px; /* right:20px â†’ 60px */
  background:rgba(10,10,18,.95);
  border:2px solid rgba(168,85,247,.5);
  border-radius:12px;
  padding:10px;
  box-shadow:0 8px 32px rgba(0,0,0,.8);
  z-index:45;
  max-width:280px;
}
#mobile-skill-panel.show{display:block;}

.mob-skill-header{display:flex;gap:6px;margin-bottom:8px;}
.mob-tab-btn{
  flex:1;padding:6px 8px;
  border:1.5px solid rgba(168,85,247,.4);
  border-radius:6px;
  background:rgba(168,85,247,.1);
  color:#9ca3af;
  font-size:11px;font-weight:700;
  cursor:pointer;transition:all .2s;
}
.mob-tab-btn.active{
  background:linear-gradient(135deg,#7c3aed,#ec4899);
  border-color:transparent;color:white;
}

.mob-skill-grid{
  display:none;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
}
.mob-skill-grid.active{display:grid;}

.mob-skill-item{
  aspect-ratio:1;
  border:1.5px solid rgba(168,85,247,.4);
  border-radius:8px;
  background:rgba(168,85,247,.15);
  color:white;font-size:20px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:transform .1s;
  box-shadow:0 2px 8px rgba(0,0,0,.4);
  position:relative;
}
.mob-skill-item:active{transform:scale(.9);}
.mob-skill-item:disabled{opacity:.4;cursor:not-allowed;}
.mob-skill-item .cost-badge{
  position:absolute;bottom:2px;right:2px;
  font-size:8px;background:rgba(0,0,0,.6);
  padding:1px 3px;border-radius:3px;
}

.mob-close-btn{
  position:absolute;top:6px;right:6px;
  width:24px;height:24px;
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.3);
  border-radius:50%;color:white;font-size:16px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}

@media (max-width:900px),(pointer:coarse){
  #joystick-zone{display:flex;width:100px;height:100px;}
  #joystick-stick{width:40px;height:40px;}
  #mobile-compact-ui{display:flex;}
}
</style>
</head>
<body>

<!-- â•â• MENU â•â• -->
<div id="menuScreen" class="screen">
  <h1>âš”ï¸ SPELL ARENA âš”ï¸</h1>
  <p class="tagline">ë§ˆë‚˜ëŠ” ë°”ë‹¥ì— ìˆê³ , ê·¸ê±¸ ë¨¹ìœ¼ëŸ¬ ê°€ëŠ” ìˆœê°„ ì•½ì ì´ ëœë‹¤</p>
  <div class="vs-row">ğŸ§™â€â™‚ï¸ VS ğŸ§™â€â™€ï¸</div>
  
  <div style="display:flex;gap:10px;width:100%;max-width:480px;margin-bottom:10px;">
    <button class="primary-btn" id="startSoloBtn" style="flex:1">ğŸ¤– ì†”ë¡œ (vs AI)</button>
    <button class="primary-btn" id="showMultiBtn" style="flex:1;background:linear-gradient(135deg,#d97706,#f59e0b)">ğŸŒ ë©€í‹°í”Œë ˆì´</button>
  </div>
  
  <div id="multiPanel" style="display:none;width:100%;max-width:480px;background:rgba(168,85,247,.1);border:2px solid rgba(168,85,247,.3);border-radius:14px;padding:14px;">
    <h3 style="color:#a855f7;margin-bottom:10px;font-size:14px;">ğŸ  ë°© ë§Œë“¤ê¸°</h3>
    <button class="primary-btn" id="createRoomBtn" style="background:linear-gradient(135deg,#d97706,#f59e0b);margin-bottom:10px">ë°© ìƒì„±í•˜ê¸°</button>
    <div id="myRoomCode" style="display:none;margin-bottom:15px;">
      <p style="color:#94a3b8;font-size:11px;margin-bottom:5px;">ì´ ì½”ë“œë¥¼ ì¹œêµ¬ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</p>
      <div style="font-size:28px;font-weight:900;letter-spacing:6px;color:#f59e0b;text-align:center;padding:8px;background:rgba(245,158,11,.1);border-radius:8px;border:1.5px solid rgba(245,158,11,.3);" id="roomCodeDisplay">----</div>
      <p style="font-size:11px;color:#94a3b8;text-align:center;margin-top:5px;" id="hostStatus">ì¹œêµ¬ê°€ ì ‘ì†í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
    </div>
    
    <h3 style="color:#a855f7;margin-bottom:10px;font-size:14px;">ğŸ”— ë°© ì°¸ê°€í•˜ê¸°</h3>
    <input style="width:100%;padding:9px 12px;border-radius:10px;background:rgba(255,255,255,.08);border:1.5px solid rgba(168,85,247,.4);color:white;font-size:16px;outline:none;margin-bottom:7px;font-family:inherit;text-transform:uppercase;letter-spacing:3px;text-align:center;" id="joinCodeInput" placeholder="ì½”ë“œ ì…ë ¥" maxlength="4">
    <button class="primary-btn" id="joinRoomBtn">ì°¸ê°€í•˜ê¸°</button>
    <p style="font-size:11px;color:#94a3b8;text-align:center;min-height:15px;margin-top:5px;" id="joinStatus"></p>
  </div>
</div>

<!-- â•â• GAME â•â• -->
<div id="gameScreen" class="screen hidden">
  <div id="center-col">
    <div id="hud">
      <div class="hud-side">
        <div class="hud-avatar">ğŸ§™â€â™‚ï¸</div>
        <div class="hud-bars">
          <div class="hud-bar-row">â¤ï¸<div class="hud-track"><div class="hud-fill hp" id="p-hp" style="width:100%"></div></div><span class="hud-val" id="p-hp-v">20</span></div>
          <div class="hud-bar-row">ğŸ’§<div class="hud-track"><div class="hud-fill mp" id="p-mp" style="width:0%"></div></div><span class="hud-val" id="p-mp-v">0</span></div>
        </div>
      </div>
      <div id="hud-mid">
        <div id="round-info">ROUND 1</div>
        <div id="timer">0:00</div>
      </div>
      <div class="hud-side right">
        <div class="hud-avatar">ğŸ§™â€â™€ï¸</div>
        <div class="hud-bars">
          <div class="hud-bar-row" style="flex-direction:row-reverse">â¤ï¸<div class="hud-track"><div class="hud-fill hp" id="e-hp" style="width:100%"></div></div><span class="hud-val" id="e-hp-v">20</span></div>
          <div class="hud-bar-row" style="flex-direction:row-reverse">ğŸ’§<div class="hud-track"><div class="hud-fill mp" id="e-mp" style="width:0%"></div></div><span class="hud-val" id="e-mp-v">0</span></div>
        </div>
      </div>
    </div>
    <div id="canvas-wrap">
      <canvas id="gameCanvas"></canvas>
      
      <!-- ì¡°ì´ìŠ¤í‹± -->
      <div id="joystick-zone">
        <div id="joystick-base">
          <div id="joystick-stick"></div>
        </div>
      </div>
      
      <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
      <div id="mobile-compact-ui">
        <button class="mob-compact-btn" id="mob-quick-spell" style="background:radial-gradient(circle at 35% 35%,#c084fc,#7c3aed);">Q</button>
        <button class="mob-compact-btn" id="mob-quick-creature" style="background:radial-gradient(circle at 35% 35%,#34d399,#059669);">W</button>
      </div>
      
      <!-- ëª¨ë°”ì¼ ìŠ¤í‚¬ íŒ¨ë„ -->
      <div id="mobile-skill-panel">
        <button class="mob-close-btn" id="mob-panel-close">Ã—</button>
        <div class="mob-skill-header">
          <button class="mob-tab-btn active" id="mob-tab-spell">ìŠ¤í </button>
          <button class="mob-tab-btn" id="mob-tab-creature">í¬ë¦¬ì²˜</button>
        </div>
        
        <div class="mob-skill-grid active" id="mob-spell-grid">
          <button class="mob-skill-item" data-spell="0">ğŸ”¥<span class="cost-badge">ğŸ’§2</span></button>
          <button class="mob-skill-item" data-spell="1">ğŸ’š<span class="cost-badge">ğŸ’§2</span></button>
          <button class="mob-skill-item" data-spell="2">âš¡<span class="cost-badge">ğŸ’§3</span></button>
          <button class="mob-skill-item" data-spell="3">â„ï¸<span class="cost-badge">ğŸ’§2</span></button>
        </div>
        
        <div class="mob-skill-grid" id="mob-creature-grid">
          <button class="mob-skill-item" data-creature="0">âš”ï¸<span class="cost-badge">ğŸ’§2</span></button>
          <button class="mob-skill-item" data-creature="1">ğŸ¹<span class="cost-badge">ğŸ’§3</span></button>
          <button class="mob-skill-item" data-creature="2">ğŸ›¡ï¸<span class="cost-badge">ğŸ’§2</span></button>
          <button class="mob-skill-item" data-creature="3">ğŸ”®<span class="cost-badge">ğŸ’§3</span></button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• OVERLAY â•â• -->
<div id="overlayScreen" class="screen hidden">
  <h2 id="overlay-title"></h2>
  <p id="overlay-sub"></p>
  <div class="overlay-btns">
    <button class="primary-btn" id="overlay-next">ê³„ì†</button>
    <button class="primary-btn ghost" id="overlay-quit">ë©”ë‰´ë¡œ</button>
  </div>
</div>

<script>
'use strict';

// CONFIG
const CFG={
  W:900,H:540,MID:450,
  MAX_HP:20,MAX_MANA:10,
  BASIC_CD:280,BASIC_DMG:3,
  MANA_REGEN:0.25,
  ORB_INTERVAL:2200,MAX_ORBS:9,
  DANGER_GRACE:1000, // ìœ„í—˜ êµ¬ì—­ ìœ ì˜ˆ ì‹œê°„
  DANGER_DPS:1.5, // ìœ„í—˜ êµ¬ì—­ ì´ˆë‹¹ ë°ë¯¸ì§€
};
const SPELL_DEFS=[
  {id:0,name:'í™”ì—¼êµ¬',cost:2,type:'proj',dmg:5, spd:7, size:14,color:'#ff4444',icon:'ğŸ”¥',cd:700},
  {id:1,name:'ì¹˜ìœ ',  cost:2,type:'heal',heal:5,icon:'ğŸ’š',cd:2500},
  {id:2,name:'ë²ˆê°œ',  cost:3,type:'proj',dmg:8, spd:12,size:11,color:'#faff00',icon:'âš¡',cd:1100},
  {id:3,name:'ì–¼ìŒ',  cost:2,type:'proj',dmg:4, spd:6.5, size:17,color:'#60a5fa',icon:'â„ï¸',cd:550},
];
const CREATURE_DEFS=[
  {id:0,name:'ê²€ì‚¬',  cost:2,atk:4,spd:4.5,icon:'âš”ï¸',size:22,color:'#22c55e',hp:1},
  {id:1,name:'ê¶ìˆ˜',  cost:3,atk:5,spd:4.2,icon:'ğŸ¹',size:20,color:'#3b82f6',hp:1,ranged:true,range:120},
  {id:2,name:'ë°©íŒ¨ë³‘',cost:2,atk:0,spd:0,  icon:'ğŸ›¡ï¸',size:26,color:'#9b59b6',hp:2,shield:true},
  {id:3,name:'ë§ˆë²•ì‚¬',cost:3,atk:6,spd:4.2,icon:'ğŸ”®',size:20,color:'#e74c3c',hp:1,ranged:true,range:100},
];

const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
const rnd=(lo,hi)=>lo+Math.random()*(hi-lo);

// CANVAS
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
function resizeCanvas(){
  const wrap=document.getElementById('canvas-wrap');
  const W2=wrap.clientWidth,H2=wrap.clientHeight;
  const scale=Math.min(W2/CFG.W,H2/CFG.H);
  canvas.width=CFG.W;canvas.height=CFG.H;
  canvas.style.width=(CFG.W*scale)+'px';
  canvas.style.height=(CFG.H*scale)+'px';
  canvas.style.left=((W2-CFG.W*scale)/2)+'px';
  canvas.style.top=((H2-CFG.H*scale)/2)+'px';
}
window.addEventListener('resize',resizeCanvas);

// KEYBOARD
const keys={};
window.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='Space') e.preventDefault();
  if(typeof G==='undefined'||G.state!=='playing') return;
  ['1','2','3','4'].forEach((k,i)=>{if(e.key===k) G.castSpell(i);});
  if(e.code==='KeyQ') G.summon(0);
  if(e.code==='KeyW') G.summon(1);
  if(e.code==='KeyE') G.summon(2);
  if(e.code==='KeyR') G.summon(3);
});
window.addEventListener('keyup',e=>{keys[e.code]=false;});

// JOYSTICK
const joy={dx:0,dy:0,moving:false};
let _joyTid=null;
let mobileShoot=false;
const joyZone=document.getElementById('joystick-zone');
const joyBase=document.getElementById('joystick-base');
const joyStick=document.getElementById('joystick-stick');
const JOY_R=48;

function _getBaseCenter(){
  const r=joyBase.getBoundingClientRect();
  return{cx:r.left+r.width/2, cy:r.top+r.height/2, w:r.width, h:r.height};
}

function _joySet(cx,cy){
  const{cx:bx,cy:by,w,h}=_getBaseCenter();
  let dx=cx-bx, dy=cy-by;
  const mag=Math.hypot(dx,dy);
  if(mag>JOY_R){const s=JOY_R/mag;dx*=s;dy*=s;}
  joyStick.style.left=(w/2+dx)+'px';
  joyStick.style.top=(h/2+dy)+'px';
  joy.dx=dx/JOY_R;
  joy.dy=dy/JOY_R;
  joy.moving=Math.hypot(dx,dy)>8;
}

function _joyReset(){
  joyStick.style.left='50%';
  joyStick.style.top='50%';
  joy.dx=0;joy.dy=0;joy.moving=false;_joyTid=null;
}

joyZone.addEventListener('touchstart',e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  _joyTid=t.identifier;
  _joySet(t.clientX,t.clientY);
},{passive:false});
joyZone.addEventListener('touchmove',e=>{
  e.preventDefault();
  for(const t of e.changedTouches){if(t.identifier===_joyTid)_joySet(t.clientX,t.clientY);}
},{passive:false});
joyZone.addEventListener('touchend',e=>{
  e.preventDefault();
  for(const t of e.changedTouches){if(t.identifier===_joyTid)_joyReset();}
},{passive:false});

// MOBILE CONTROLS
const mobSkillPanel = document.getElementById('mobile-skill-panel');
const mobQuickSpell = document.getElementById('mob-quick-spell');
const mobQuickCreature = document.getElementById('mob-quick-creature');

document.addEventListener('touchstart', (e) => {
  const target = e.target;
  if(target.tagName === 'CANVAS' || target.id === 'canvas-wrap') {
    mobileShoot = true;
  }
}, {passive: true});

document.addEventListener('touchend', () => {
  mobileShoot = false;
}, {passive: true});

mobQuickSpell.addEventListener('click', () => {
  if(mobSkillPanel.classList.contains('show')) {
    mobSkillPanel.classList.remove('show');
  } else {
    mobSkillPanel.classList.add('show');
    document.getElementById('mob-tab-spell').classList.add('active');
    document.getElementById('mob-tab-creature').classList.remove('active');
    document.getElementById('mob-spell-grid').classList.add('active');
    document.getElementById('mob-creature-grid').classList.remove('active');
  }
});

mobQuickCreature.addEventListener('click', () => {
  if(mobSkillPanel.classList.contains('show')) {
    mobSkillPanel.classList.remove('show');
  } else {
    mobSkillPanel.classList.add('show');
    document.getElementById('mob-tab-spell').classList.remove('active');
    document.getElementById('mob-tab-creature').classList.add('active');
    document.getElementById('mob-spell-grid').classList.remove('active');
    document.getElementById('mob-creature-grid').classList.add('active');
  }
});

document.getElementById('mob-panel-close').addEventListener('click', () => {
  mobSkillPanel.classList.remove('show');
});

document.getElementById('mob-tab-spell').addEventListener('click', () => {
  document.getElementById('mob-tab-spell').classList.add('active');
  document.getElementById('mob-tab-creature').classList.remove('active');
  document.getElementById('mob-spell-grid').classList.add('active');
  document.getElementById('mob-creature-grid').classList.remove('active');
});

document.getElementById('mob-tab-creature').addEventListener('click', () => {
  document.getElementById('mob-tab-spell').classList.remove('active');
  document.getElementById('mob-tab-creature').classList.add('active');
  document.getElementById('mob-spell-grid').classList.remove('active');
  document.getElementById('mob-creature-grid').classList.add('active');
});

document.querySelectorAll('#mob-spell-grid .mob-skill-item').forEach(btn => {
  btn.addEventListener('click', () => {
    G.castSpell(parseInt(btn.dataset.spell));
    mobSkillPanel.classList.remove('show');
  });
});

document.querySelectorAll('#mob-creature-grid .mob-skill-item').forEach(btn => {
  btn.addEventListener('click', () => {
    G.summon(parseInt(btn.dataset.creature));
    mobSkillPanel.classList.remove('show');
  });
});

// ENTITIES
class Particle{
  constructor(x,y,color,n=8){
    this.dead=false;this._p=[];
    for(let i=0;i<n;i++){
      const a=rnd(0,Math.PI*2),s=rnd(1.5,4.5);
      this._p.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,color});
    }
  }
  update(){
    this._p.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vx*=.87;p.vy*=.87;p.life-=.042;});
    this._p=this._p.filter(p=>p.life>0);
    if(!this._p.length) this.dead=true;
  }
  draw(c){
    this._p.forEach(p=>{
      c.globalAlpha=Math.max(0,p.life);c.fillStyle=p.color;
      c.beginPath();c.arc(p.x,p.y,3.5*p.life,0,Math.PI*2);c.fill();
    });
    c.globalAlpha=1;
  }
}

class Projectile{
  constructor({x,y,vx,vy,dmg,size,color,owner,spellId,kind}){
    Object.assign(this,{x,y,vx,vy,dmg,size,color,owner,spellId:spellId||null,kind:kind||null,dead:false,createdAt:performance.now()});
    this._trail=[];
  }
  update(){
    this._trail.unshift({x:this.x,y:this.y});
    if(this._trail.length>5) this._trail.pop();
    if(this.spellId===3){
      const elapsed=performance.now()-this.createdAt;
      this.y+=Math.sin(elapsed*0.01)*4;
    }
    this.x+=this.vx;this.y+=this.vy;
    if(this.x<-20||this.x>CFG.W+20||this.y<-20||this.y>CFG.H+20) this.dead=true;
  }
  draw(c){
    this._trail.forEach((t,i)=>{
      c.globalAlpha=(1-i/this._trail.length)*.4;
      c.fillStyle=this.color;c.beginPath();
      c.arc(t.x,t.y,this.size*(1-i*.18),0,Math.PI*2);c.fill();
    });
    c.globalAlpha=1;c.fillStyle=this.color;
    c.shadowBlur=18;c.shadowColor=this.color;
    
    // í™”ì‚´ì´ë‚˜ ë³¼íŠ¸ëŠ” íŠ¹ë³„í•˜ê²Œ ê·¸ë¦¬ê¸°
    if(this.kind==='arrow'){
      const ang=Math.atan2(this.vy,this.vx);
      c.save();c.translate(this.x,this.y);c.rotate(ang);
      c.fillStyle=this.color;
      c.fillRect(-this.size*1.5,-this.size*0.3,this.size*2.5,this.size*0.6);
      c.beginPath();
      c.moveTo(this.size,0);
      c.lineTo(-this.size*0.3,-this.size*0.8);
      c.lineTo(-this.size*0.3,this.size*0.8);
      c.closePath();c.fill();
      c.restore();
    } else if(this.kind==='bolt'){
      const ang=Math.atan2(this.vy,this.vx);
      c.save();c.translate(this.x,this.y);c.rotate(ang);
      c.fillStyle=this.color;
      c.beginPath();
      c.moveTo(-this.size,0);
      c.lineTo(-this.size*0.2,-this.size*1.2);
      c.lineTo(this.size*0.6,0);
      c.lineTo(-this.size*0.2,this.size*1.2);
      c.closePath();c.fill();
      c.restore();
    } else {
      c.beginPath();c.arc(this.x,this.y,this.size,0,Math.PI*2);c.fill();
    }
    
    c.shadowBlur=0;
  }
}

class ManaOrb{
  constructor(seed){
    const r=(seed!==undefined)?seed:Math.random();
    if(r<.3){this.x=rnd(40,CFG.MID-80);this.bonus=1;}
    else if(r<.7){this.x=rnd(CFG.MID-90,CFG.MID+90);this.bonus=1;}
    else{this.x=rnd(CFG.MID+80,CFG.W-40);this.bonus=2;}
    this.y=rnd(55,CFG.H-55);this.pulse=rnd(0,Math.PI*2);
    this.dead=false;this.rich=(this.bonus>1);
  }
  update(){this.pulse+=.06;}
  draw(c){
    const r=9+Math.sin(this.pulse)*2.5;
    const g=c.createRadialGradient(this.x,this.y,1,this.x,this.y,r);
    g.addColorStop(0,this.rich?'#fef08a':'#e9d5ff');
    g.addColorStop(1,this.rich?'#f59e0b00':'#a855f700');
    c.fillStyle=g;c.shadowBlur=16;c.shadowColor=this.rich?'#f59e0b':'#a855f7';
    c.beginPath();c.arc(this.x,this.y,r,0,Math.PI*2);c.fill();c.shadowBlur=0;
    c.fillStyle=this.rich?'#fbbf24':'#d8b4fe';
    c.font='bold 9px Segoe UI';c.textAlign='center';
    c.fillText(`+${this.bonus}`,this.x,this.y+r+11);
  }
}

class Creature{
  constructor(def,owner,x,y){
    Object.assign(this,def);
    this.owner=owner;this.x=x;this.y=y;
    this.currentHp=def.hp;this.dead=false;
    this.ranged=!!def.ranged;
    this.range=def.range||0;
    this.tempId=Math.random().toString(36).substr(2,9); // ê³ ìœ  ID
  }
  update(target, enemyCreatures){
    if(this.shield||this.spd===0) return null;
    
    let actualTarget=target;
    let targetIsCreature=false;
    
    // ì  í¬ë¦¬ì²˜ê°€ ìˆìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ì  í¬ë¦¬ì²˜ë¥¼ ìš°ì„  íƒ€ê²ŸíŒ…
    if(enemyCreatures && enemyCreatures.length>0){
      let nearestCreature=null;
      let nearestDist=Infinity;
      
      for(const ec of enemyCreatures){
        if(ec.dead) continue;
        const d=dist(this,ec);
        if(d<nearestDist){
          nearestDist=d;
          nearestCreature=ec;
        }
      }
      
      // ê°€ê¹Œìš´ ì  í¬ë¦¬ì²˜ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ íƒ€ê²Ÿìœ¼ë¡œ
      if(nearestCreature && nearestDist<150){
        actualTarget=nearestCreature;
        targetIsCreature=true;
      }
    }
    
    const dx=actualTarget.x-this.x,dy=actualTarget.y-this.y,d=Math.hypot(dx,dy);
    
    // ì›ê±°ë¦¬ í¬ë¦¬ì²˜ëŠ” ì‚¬ê±°ë¦¬ ë‚´ì—ì„œ ë°œì‚¬ì²´ ê³µê²©
    if(this.ranged && d<=this.range){
      const ang=Math.atan2(actualTarget.y-this.y,actualTarget.x-this.x);
      const spd=6;
      const px=this.x+Math.cos(ang)*(this.size+6);
      const py=this.y+Math.sin(ang)*(this.size+6);
      const kind = this.icon==='ğŸ¹'?'arrow':'bolt';
      this.dead=true; // í•œ ë²ˆ ê³µê²© í›„ ì†Œë©¸
      return new Projectile({
        x:px,y:py,
        vx:Math.cos(ang)*spd,
        vy:Math.sin(ang)*spd,
        dmg:this.atk,
        size:8,
        color:this.color,
        owner:this.owner,
        kind:kind
      });
    }
    
    // ì›ê±°ë¦¬ í¬ë¦¬ì²˜ê°€ ì‚¬ê±°ë¦¬ ë°–ì´ë©´ ì ‘ê·¼
    if(this.ranged && d>this.range){
      this.x+=(dx/d)*this.spd;
      this.y+=(dy/d)*this.spd;
      return null;
    }
    
    // ê·¼ì ‘ í¬ë¦¬ì²˜ëŠ” ì ì—ê²Œ ë‹¤ê°€ê°
    if(!this.ranged){
      if(d>28){
        this.x+=(dx/d)*this.spd;
        this.y+=(dy/d)*this.spd;
      } else {
        // ê°€ê¹Œì›Œì§€ë©´ ë°ë¯¸ì§€ë¥¼ ì£¼ê³  ì†Œë©¸
        if(targetIsCreature){
          // ì  í¬ë¦¬ì²˜ ê³µê²©
          if(actualTarget.shield){
            actualTarget.currentHp=Math.max(0,actualTarget.currentHp-this.atk);
            if(actualTarget.currentHp<=0) actualTarget.dead=true;
          } else {
            actualTarget.dead=true;
          }
        } else {
          // ì  í”Œë ˆì´ì–´ ê³µê²© (ë°©íŒ¨ë³‘ ë¨¼ì € ì²´í¬)
          const shield=actualTarget.creatures?.find(c=>c.shield&&!c.dead);
          if(shield){
            shield.currentHp=Math.max(0,shield.currentHp-this.atk);
            if(shield.currentHp<=0) shield.dead=true;
          } else {
            actualTarget.hp=Math.max(0,actualTarget.hp-this.atk);
          }
        }
        this.dead=true;
      }
    }
    
    return null;
  }
  draw(c){
    const isPlayer=this.owner==='player';
    const x=this.x,y=this.y;
    const bodyColor=this.color;
    const glowColor=isPlayer?'#22c55e':'#f97316';
    
    c.shadowBlur=14;c.shadowColor=glowColor;
    
    if(this.icon==='âš”ï¸'){
      // ê²€ì‚¬
      c.fillStyle=bodyColor;
      c.fillRect(x-this.size/2.3,y-2,this.size/1.15,this.size*1.3);
      c.beginPath();c.arc(x,y-13,this.size*0.7,0,Math.PI*2);c.fill();
      c.fillStyle='rgba(255,255,255,.3)';
      c.fillRect(x-this.size*0.15,y-15,this.size*0.3,this.size*0.4);
      c.fillStyle=bodyColor;
      c.strokeStyle=bodyColor;c.lineWidth=this.size*0.35;c.lineCap='round';
      c.beginPath();c.moveTo(x-this.size/2,y+2);c.lineTo(x-this.size,y-4);c.stroke();
      c.beginPath();c.moveTo(x+this.size/2,y+2);c.lineTo(x+this.size/1.2,y-8);c.stroke();
      c.strokeStyle='#fbbf24';c.lineWidth=3;
      c.beginPath();c.moveTo(x+this.size/1.2,y-8);c.lineTo(x+this.size/1.1,y-18);c.stroke();
    } else if(this.icon==='ğŸ¹'){
      // ê¶ìˆ˜
      c.fillStyle=bodyColor;
      c.fillRect(x-this.size/2.6,y-this.size/1.2,this.size/1.3,this.size*1.3);
      c.beginPath();c.arc(x,y-14,this.size*0.68,0,Math.PI*2);c.fill();
      c.strokeStyle='#d97706';c.lineWidth=3;
      c.beginPath();
      c.arc(x+8,y-4,this.size*0.8,Math.PI*0.7,Math.PI*1.3);c.stroke();
      c.strokeStyle='#f5f5f5';c.lineWidth=1;
      c.beginPath();c.moveTo(x+6,y-10);c.lineTo(x+10,y+2);c.stroke();
    } else if(this.shield){
      // ë°©íŒ¨ë³‘
      c.fillStyle=bodyColor;
      c.fillRect(x-this.size/2.2,y,this.size/1.1,this.size*1.2);
      c.beginPath();c.arc(x,y-12,this.size*0.7,0,Math.PI*2);c.fill();
      c.fillStyle='#7c2d12';
      c.beginPath();
      c.moveTo(x+this.size/1.5,y+2);c.lineTo(x+this.size/1.2,y+12);
      c.lineTo(x+this.size/1.5,y+18);c.lineTo(x+this.size/1.8,y+8);c.closePath();c.fill();
      c.fillStyle='#b45309';
      c.beginPath();
      c.moveTo(x+this.size/1.5,y+4);c.lineTo(x+this.size/1.3,y+10);
      c.lineTo(x+this.size/1.5,y+14);c.lineTo(x+this.size/1.7,y+8);c.closePath();c.fill();
      c.strokeStyle=bodyColor;c.lineWidth=this.size*0.3;c.lineCap='round';
      c.beginPath();c.moveTo(x-this.size/3,y+2);c.lineTo(x-this.size,y+4);c.stroke();
      c.beginPath();c.moveTo(x+this.size/4,y+2);c.lineTo(x+this.size/2,y+8);c.stroke();
    } else if(this.icon==='ğŸ”®'){
      // ë§ˆë²•ì‚¬
      c.fillStyle=bodyColor;
      c.beginPath();
      c.moveTo(x-this.size/1.8,y-2);c.lineTo(x-this.size/1.3,y+13);
      c.lineTo(x+this.size/1.3,y+13);c.lineTo(x+this.size/1.8,y-2);
      c.arc(x,y-12,this.size*0.7,0,Math.PI,true);c.closePath();c.fill();
      c.beginPath();c.arc(x,y-12,this.size*0.72,0,Math.PI*2);c.fill();
      c.beginPath();
      c.moveTo(x-this.size/1.5,y-11);c.lineTo(x,y-22);c.lineTo(x+this.size/1.5,y-11);c.closePath();c.fill();
      c.fillStyle='rgba(255,255,255,.3)';
      c.fillRect(x-this.size/1.4,y-11.5,this.size/0.75,this.size*0.4);
      c.fillStyle=bodyColor;
      c.strokeStyle='#d4af37';c.lineWidth=2;c.lineCap='round';
      c.beginPath();c.moveTo(x+this.size/2,y+5);c.lineTo(x+this.size/1.1,y-18);c.stroke();
      c.fillStyle='#f59e0b';c.shadowBlur=12;c.shadowColor='#f59e0b';
      c.beginPath();c.arc(x+this.size/1.1,y-20,this.size*0.4,0,Math.PI*2);c.fill();
    }
    
    c.shadowBlur=0;
    if(this.hp>1){
      const bw=this.size*2;
      c.fillStyle='rgba(0,0,0,.6)';c.fillRect(x-bw/2,y-this.size-10,bw,5);
      c.fillStyle='#a855f7';c.fillRect(x-bw/2,y-this.size-10,bw*(this.currentHp/this.hp),5);
    }
  }
}

class Character{
  constructor({x,y,color,label,facing,side}){
    this.x=x;this.y=y;this.color=color;this.label=label;
    this.facing=facing;this.side=side;
    this.startX=x; // ì´ˆê¸° ìœ„ì¹˜ ì €ì¥
    this.hp=CFG.MAX_HP;this.maxHp=CFG.MAX_HP;
    this.mana=0;this.maxMana=CFG.MAX_MANA;
    this.speed=4.5; // ì´ë™ì†ë„ ì¦ê°€
    this.creatures=[];
    this.basicCd=0;this.spellCd={};
    this.dangerTimer=0; // ìœ„í—˜ êµ¬ì—­ íƒ€ì´ë¨¸
  }
  
  // ìœ„í—˜ êµ¬ì—­ ì²´í¬ (ê°€ìš´ë° ì„  ë„˜ì–´ê°€ë©´)
  isInDanger(){
    if(this.startX<CFG.MID) return this.x>CFG.MID+40; // ì™¼ìª½ì—ì„œ ì‹œì‘: ì˜¤ë¥¸ìª½ì´ ìœ„í—˜
    else return this.x<CFG.MID-40; // ì˜¤ë¥¸ìª½ì—ì„œ ì‹œì‘: ì™¼ìª½ì´ ìœ„í—˜
  }
  
  // ìœ„í—˜ êµ¬ì—­ ë°ë¯¸ì§€ ì²˜ë¦¬
  updateDanger(dt){
    if(this.isInDanger()){
      this.dangerTimer+=dt;
      if(this.dangerTimer>CFG.DANGER_GRACE){
        this.hp=Math.max(0,this.hp-CFG.DANGER_DPS*(dt/1000));
      }
    } else {
      this.dangerTimer=Math.max(0,this.dangerTimer-dt*2);
    }
  }
  draw(c){
    const T=Date.now();
    const{x,y,color,facing,side}=this;
    const isMoving=(side==='player')
      ?(joy.moving||keys['ArrowLeft']||keys['ArrowRight']||keys['ArrowUp']||keys['ArrowDown'])
      :true;
    const leg=isMoving?Math.sin(T*.012)*11:0;
    const arm=isMoving?Math.sin(T*.012)*9:0;
    const dir=facing==='right'?1:-1;
    
    // Shadow
    c.fillStyle='rgba(0,0,0,.28)';
    c.beginPath();c.ellipse(x,y+34,24,8,0,0,Math.PI*2);c.fill();
    
    // Legs
    c.strokeStyle=color+'aa';c.lineWidth=12;c.lineCap='round';
    c.beginPath();c.moveTo(x-7,y+20);c.lineTo(x-7,y+36+leg);c.stroke();
    c.beginPath();c.moveTo(x+7,y+20);c.lineTo(x+7,y+36-leg);c.stroke();
    
    // Body
    const bg=c.createLinearGradient(x-16,y-14,x+16,y+24);
    bg.addColorStop(0,color);bg.addColorStop(1,color+'88');
    c.fillStyle=bg;c.shadowBlur=10;c.shadowColor=color+'60';
    c.fillRect(x-16,y-14,32,38);c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.65)';c.lineWidth=2;c.strokeRect(x-16,y-14,32,38);
    c.fillStyle='rgba(255,255,255,.1)';c.fillRect(x-11,y-10,22,10);
    
    // Arms - ê³µê²© ì‹œ íŒ” ìœ„ì¹˜ ë³€ê²½
    let attackArmOffset=0;
    let isAttacking=false;
    let weaponAngle=0;
    
    // ì¹¼ íœ˜ë‘ë¥´ê¸° ì‹œê°„ ë‹¨ì¶• (400ms â†’ 250ms)
    const SWING_TIME=250;
    
    if(side==='player' && G.lastPlayerBasicT && T-G.lastPlayerBasicT<SWING_TIME){
      isAttacking=true;
      const elapsed=Math.min(SWING_TIME,T-G.lastPlayerBasicT);
      const progress=elapsed/SWING_TIME;
      attackArmOffset=Math.sin(progress*Math.PI)*30; // íŒ”ì„ ë” í¬ê²Œ ì›€ì§ì„
      // ìœ„ì—ì„œ ì•„ë˜ë¡œ 180ë„ íšŒì „ - dir ê³±ì…ˆ ì œê±°!
      weaponAngle=-Math.PI/2 + Math.PI*progress;
    } else if(side==='enemy' && G.lastEnemyBasicT && T-G.lastEnemyBasicT<SWING_TIME){
      isAttacking=true;
      const elapsed=Math.min(SWING_TIME,T-G.lastEnemyBasicT);
      const progress=elapsed/SWING_TIME;
      attackArmOffset=Math.sin(progress*Math.PI)*30;
      weaponAngle=-Math.PI/2 + Math.PI*progress;
    } else {
      // í‰ì†Œì—ëŠ” ì˜†ìœ¼ë¡œ ë“¤ê³  ìˆìŒ
      weaponAngle=0;
    }
    
    c.strokeStyle=color;c.lineWidth=10;
    c.beginPath();c.moveTo(x-16,y-4);c.lineTo(x-26*dir,y+12+arm);c.stroke();
    // ê³µê²©í•˜ëŠ” íŒ” (ì¹¼ ë“  íŒ”)
    c.beginPath();c.moveTo(x+16,y-4);c.lineTo(x+28*dir,y+10-arm-attackArmOffset);c.stroke();
    
    // Head
    c.fillStyle='#fbbf24';c.shadowBlur=7;c.shadowColor='#fbbf2450';
    c.beginPath();c.arc(x,y-28,17,0,Math.PI*2);c.fill();c.shadowBlur=0;
    c.strokeStyle='rgba(255,255,255,.75)';c.lineWidth=2;c.stroke();
    const ex=dir*5;
    c.fillStyle='#111';c.fillRect(x+ex-4,y-32,4,4);c.fillRect(x+ex+4,y-32,4,4);
    c.strokeStyle='#333';c.lineWidth=2;c.beginPath();c.arc(x+ex,y-24,4,0,Math.PI);c.stroke();
    
    // Weapon (ì¹¼) - ì†ì— ë“¤ê³  ì‹¤ì œë¡œ íšŒì „!!!
    c.save();
    
    // ì¢Œìš° ë°˜ì „ì„ ìœ„í•œ ìŠ¤ì¼€ì¼ ì ìš©
    if(dir<0){
      c.translate(x-28,y+10-arm-attackArmOffset);
      c.scale(-1,1); // ì™¼ìª½ í–¥í•  ë•Œ ì¢Œìš° ë°˜ì „
      c.rotate(weaponAngle);
    } else {
      c.translate(x+28,y+10-arm-attackArmOffset);
      c.rotate(weaponAngle);
    }
    
    // ì¹¼ë‚  - ê³µê²© ì‹œ ë” ë°ê³  í¬ê²Œ
    const swordScale = isAttacking ? 1.2 : 1;
    c.fillStyle=isAttacking?'#ffffff':'#e0e0e0';
    c.shadowBlur=isAttacking?30:12;
    c.shadowColor=isAttacking?'#fff':'#ccc';
    c.beginPath();
    c.moveTo(0,-6*swordScale);
    c.lineTo(55*swordScale,-4*swordScale);
    c.lineTo(55*swordScale,4*swordScale);
    c.lineTo(0,6*swordScale);
    c.closePath();
    c.fill();
    
    // ì¹¼ ë
    c.fillStyle=isAttacking?'#ffffff':'#f0f0f0';
    c.beginPath();
    c.moveTo(55*swordScale,-4*swordScale);
    c.lineTo(65*swordScale,0);
    c.lineTo(55*swordScale,4*swordScale);
    c.closePath();
    c.fill();
    
    // ì¹¼ë‚  ë¹› ë°˜ì‚¬
    c.fillStyle=isAttacking?'rgba(255,255,255,0.9)':'rgba(255,255,255,0.5)';
    c.fillRect(12*swordScale,-2*swordScale,38*swordScale,2*swordScale);
    
    c.shadowBlur=0;
    
    // ì†ì¡ì´
    c.fillStyle='#654321';
    c.fillRect(-10,-5,10,10);
    
    // ì†ì¡ì´ ì¥ì‹
    c.fillStyle='#ffd700';
    c.fillRect(-12,-6,3,12);
    c.fillRect(0,-6,3,12);
    
    // ê³µê²© ì‹œ ì”ìƒ íš¨ê³¼ - ì¹¼ì´ ì§€ë‚˜ê°„ ìë¦¬ (ë” ë‘ê»ê³  ì„ ëª…í•˜ê²Œ)
    if(isAttacking){
      const elapsed=side==='player'?(T-G.lastPlayerBasicT):(T-G.lastEnemyBasicT);
      const progress=elapsed/SWING_TIME;
      if(progress>0.1){ // ì¡°ê¸ˆ íœ˜ë‘ë¥¸ í›„ë¶€í„° ì”ìƒ
        c.globalAlpha=0.5*(1-progress);
        c.strokeStyle=side==='player'?'#60a5fa':'#f87171';
        c.lineWidth=12; // ë” ë‘ê»ê²Œ
        c.shadowBlur=15;
        c.shadowColor=side==='player'?'#60a5fa':'#f87171';
        // ì¹¼ì´ ì§€ë‚˜ê°„ ê¶¤ì 
        c.beginPath();
        const startA=-Math.PI/2;
        c.arc(0,0,50,startA,weaponAngle,false);
        c.stroke();
        c.shadowBlur=0;
        c.globalAlpha=1;
      }
    }
    
    c.restore();
    
    // HP bar
    const hp=this.hp/this.maxHp;
    c.fillStyle='rgba(0,0,0,.7)';c.fillRect(x-34,y-52,68,9);
    const hbg=c.createLinearGradient(x-34,0,x+34,0);
    if(side==='player'){hbg.addColorStop(0,'#10b981');hbg.addColorStop(1,'#34d399');}
    else{hbg.addColorStop(0,'#ef4444');hbg.addColorStop(1,'#f87171');}
    c.fillStyle=hbg;c.fillRect(x-34,y-52,68*hp,9);
    c.strokeStyle='rgba(255,255,255,.25)';c.lineWidth=1;c.strokeRect(x-34,y-52,68,9);
    
    // Name
    c.font='bold 12px Segoe UI';c.textAlign='center';
    c.strokeStyle='#000';c.lineWidth=3.5;c.strokeText(this.label,x,y-64);
    c.fillStyle=color;c.fillText(this.label,x,y-64);
    
    // ìœ„í—˜ êµ¬ì—­ ê²½ê³ 
    if(this.dangerTimer>0){
      c.font='bold 12px Segoe UI';c.textAlign='center';
      if(this.dangerTimer<CFG.DANGER_GRACE){
        c.fillStyle='rgba(251,191,36,.9)';
        c.fillText(`âš ï¸ ${((CFG.DANGER_GRACE-this.dangerTimer)/1000).toFixed(1)}s`,x,y-72);
      } else {
        c.fillStyle='rgba(239,68,68,.95)';
        c.fillText('ğŸ”¥ ë°ë¯¸ì§€!',x,y-72);
        // ìœ„í—˜ êµ¬ì—­ ë§
        const a=.5+Math.sin(T*.012)*.4;
        c.strokeStyle=`rgba(239,68,68,${a})`;c.lineWidth=3;
        c.shadowBlur=12;c.shadowColor='#ef4444';
        c.beginPath();c.arc(x,y,42,0,Math.PI*2);c.stroke();c.shadowBlur=0;
      }
    }
  }
}

// AI
class AICtrl{
  constructor(e,p){
    this.e=e;this.p=p;
    this.target={x:e.x,y:e.y};
    this.nextMove=0;this.spellT=0;this.creatureT=0;
  }
  tick(now,orbs,projs){
    const e=this.e,p=this.p;
    if(now>this.nextMove){
      this.nextMove=now+rnd(600,1400);
      if(e.hp<e.maxHp*.35)
        this.target={x:rnd(CFG.MID+60,CFG.W-60),y:rnd(80,CFG.H-80)};
      else if(e.mana<4){
        const o=orbs.filter(o=>o.x>CFG.MID).sort((a,b)=>dist(e,a)-dist(e,b))[0];
        if(o) this.target={x:o.x,y:o.y};
        else this.target={x:rnd(CFG.MID+20,CFG.W-50),y:rnd(80,CFG.H-80)};
      } else {
        const o=orbs.filter(o=>o.x>CFG.MID).sort((a,b)=>dist(e,a)-dist(e,b))[0];
        if(o) this.target={x:o.x,y:o.y};
        else this.target={x:rnd(CFG.MID+30,CFG.W-50),y:rnd(80,CFG.H-80)};
      }
    }
    const dx=this.target.x-e.x,dy=this.target.y-e.y,d=Math.hypot(dx,dy);
    if(d>6){e.x+=(dx/d)*e.speed;e.y+=(dy/d)*e.speed;}
    e.x=clamp(e.x,28,CFG.W-28);e.y=clamp(e.y,55,CFG.H-28);
    e.facing=e.x<p.x?'right':'left';
    
    if(now>this.spellT&&e.mana>=2){
      let def=null;
      const hpLow = e.hp < e.maxHp * 0.6;
      if(hpLow && e.mana >= SPELL_DEFS[1].cost) {
        def = SPELL_DEFS[1];
      } else {
        const candidates = SPELL_DEFS.filter(d=> e.mana >= d.cost + (d.type==='proj'?1:0));
        if(candidates.length>0){
          def = candidates[Math.floor(Math.random()*candidates.length)];
        }
      }
      if(def && e.mana>=def.cost){
        if(def.type==='heal'){
          e.hp = Math.min(e.maxHp, e.hp + def.heal);
        } else {
          const ang = Math.atan2(p.y-e.y, p.x-e.x);
          projs.push(new Projectile({x:e.x-28,y:e.y-8,vx:Math.cos(ang)*def.spd,vy:Math.sin(ang)*def.spd,dmg:def.dmg,size:def.size,color:def.color,owner:'enemy'}));
        }
        e.mana -= def.cost;
        this.spellT = now + (def.type==='heal' ? rnd(2000,3500) : rnd(1400,3000));
      }
    }
    
    if(now>this.creatureT && e.creatures.length<5){
      const affordable = CREATURE_DEFS.filter(d=> e.mana >= d.cost + 1);
      if(affordable.length>0 && Math.random()<0.5){
        const def = affordable[Math.floor(Math.random()*affordable.length)];
        e.creatures.push(new Creature(def,'enemy',e.x-50,e.y+rnd(-50,50)));
        e.mana -= def.cost;
        this.creatureT = now + rnd(2500,4500);
      } else {
        this.creatureT = now + rnd(1200,2600);
      }
    }
    
    e.basicCd-=16;
    if(e.basicCd<=0&&Math.random()<.013){
      G.lastEnemyBasicT=now; // AI ê³µê²© ì‹œê°„ ê¸°ë¡
      e.basicCd=CFG.BASIC_CD;
    }
  }
}

// GAME ENGINE
const G={
  state:'menu',
  roundNum:1,playerWins:0,enemyWins:0,
  player:null,enemy:null,remote:null,
  projectiles:[],orbs:[],particles:[],
  ai:null,
  isMulti:false,
  _ivals:{},_lastT:0,
  lastPlayerBasicT:0, // í”Œë ˆì´ì–´ ê³µê²© ì‹œê°„
  lastEnemyBasicT:0, // ì  ê³µê²© ì‹œê°„
  swordHitEnemy:false, // ì¹¼ì´ ì ì„ ë§ì·„ëŠ”ì§€ (ì¤‘ë³µ ë°©ì§€)

  _clearIvals(){
    Object.values(this._ivals).forEach(clearInterval);
    this._ivals={};
  },

  startRound(){
    this.projectiles=[];this.orbs=[];this.particles=[];
    this._clearIvals();

    const playerX=(!this.isMulti||isHost)?160:CFG.W-160;
    const playerFacing=(!this.isMulti||isHost)?'right':'left';
    this.player=new Character({x:playerX,y:CFG.H/2,color:'#60a5fa',label:'ë‚˜',facing:playerFacing,side:'player'});

    if(this.isMulti){
      const remX=isHost?CFG.W-160:160;
      const remF=isHost?'left':'right';
      this.remote=new Character({x:remX,y:CFG.H/2,color:'#f87171',label:'ìƒëŒ€',facing:remF,side:'enemy'});
      this.enemy=this.remote;
      this.ai=null;
    } else {
      this.enemy=new Character({x:CFG.W-160,y:CFG.H/2,color:'#f87171',label:'AI',facing:'left',side:'enemy'});
      this.remote=null;
      this.ai=new AICtrl(this.enemy,this.player);
    }

    document.getElementById('menuScreen').classList.add('hidden');
    document.getElementById('overlayScreen').classList.add('hidden');
    document.getElementById('gameScreen').classList.remove('hidden');
    resizeCanvas();

    let sec=0;
    this._ivals.timer=setInterval(()=>{
      sec++;
      const m=Math.floor(sec/60),s=sec%60;
      document.getElementById('timer').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    },1000);

    const spawnOrb=()=>{
      if(this.state!=='playing'||this.orbs.length>=CFG.MAX_ORBS) return;
      this.orbs.push(new ManaOrb());
    };
    for(let i=0;i<3;i++) spawnOrb();
    this._ivals.orb=setInterval(spawnOrb,CFG.ORB_INTERVAL);

    this._ivals.regen=setInterval(()=>{
      if(this.state!=='playing') return;
      this.player.mana=Math.min(CFG.MAX_MANA,this.player.mana+CFG.MANA_REGEN);
      this.enemy.mana=Math.min(CFG.MAX_MANA,this.enemy.mana+CFG.MANA_REGEN);
      this.updateHUD();
    },1000);

    this.updateRoundHUD();
    this.state='playing';
    this._lastT=performance.now();
    
    // ë©€í‹°í”Œë ˆì´ state sync
    if(this.isMulti){
      this._ivals.net=setInterval(()=>{
        if(this.state!=='playing'||!this.player) return;
        netSend({
          t:'s',
          x:Math.round(this.player.x),
          y:Math.round(this.player.y),
          f:this.player.facing,
          hp:Math.round(this.player.hp*10)/10,
          mn:Math.round(this.player.mana*10)/10,
          cr:this.player.creatures.map(c=>({
            i:c.id,
            tid:c.tempId,
            x:Math.round(c.x),
            y:Math.round(c.y),
            h:c.currentHp
          }))
        });
      },50); // 20Hz
    }
    
    requestAnimationFrame(t=>this._loop(t));
  },

  castSpell(i){
    if(this.state!=='playing') return;
    const def=SPELL_DEFS[i],p=this.player,now=performance.now();
    if(!def||p.mana<def.cost) return;
    if(p.spellCd[i]&&now<p.spellCd[i]) return;
    if(def.type==='proj'){
      const dir=p.facing==='right'?1:-1;
      const pj=new Projectile({
        x:p.x+dir*30,y:p.y-8,
        vx:dir*def.spd,vy:0,
        dmg:def.dmg,size:def.size,color:def.color,
        owner:'player',spellId:i,
      });
      this.projectiles.push(pj);
      // ë©€í‹°í”Œë ˆì´ ë°œì‚¬ì²´ ì „ì†¡
      if(this.isMulti) netSend({t:'p',x:pj.x,y:pj.y,vx:pj.vx,vy:pj.vy,dm:pj.dmg,sz:pj.size,cl:pj.color});
      p.mana-=def.cost;
    } else if(def.type==='heal'){
      p.hp=Math.min(p.maxHp,p.hp+def.heal);
      this.particles.push(new Particle(p.x,p.y,'#34d399',14));
      p.mana-=def.cost;
      // ë©€í‹°í”Œë ˆì´ ì¹˜ìœ  ì „ì†¡
      if(this.isMulti) netSend({t:'sp',i:i,hp:p.hp});
    }
    p.spellCd[i]=now+def.cd;
    this.updateHUD();
  },

  summon(i){
    if(this.state!=='playing') return;
    const def=CREATURE_DEFS[i],p=this.player;
    if(!def||p.mana<def.cost||p.creatures.length>=8) return;
    const cx=p.x+(p.facing==='right'?52:-52),cy=p.y+rnd(-60,60);
    const newCreature = new Creature(def,'player',cx,cy);
    p.creatures.push(newCreature);
    p.mana-=def.cost;
    
    // ë©€í‹°í”Œë ˆì´ í¬ë¦¬ì²˜ ì†Œí™˜ ì „ì†¡
    if(this.isMulti){
      netSend({t:'cr',i:i,x:cx,y:cy,tid:newCreature.tempId});
    }
    
    this.updateHUD();
  },

  _loop(t){
    if(this.state!=='playing') return;
    const dt=Math.min(50,t-this._lastT);this._lastT=t;
    this._update(dt,t);
    this._render();
    requestAnimationFrame(ts=>this._loop(ts));
  },

  _update(dt,now){
    const p=this.player,e=this.enemy;

    // Player movement
    let dx=0,dy=0;
    if(joy.moving){dx=joy.dx;dy=joy.dy;}
    else{
      if(keys['ArrowLeft']||keys['KeyA'])  dx-=1;
      if(keys['ArrowRight']||keys['KeyD']) dx+=1;
      if(keys['ArrowUp'])    dy-=1;
      if(keys['ArrowDown']||keys['KeyS'])  dy+=1;
      if(dx&&dy){dx*=.707;dy*=.707;}
    }
    if(dx>0) p.facing='right';
    else if(dx<0) p.facing='left';
    p.x=clamp(p.x+dx*p.speed,28,CFG.W-28);
    p.y=clamp(p.y+dy*p.speed,55,CFG.H-28);
    
    // ìœ„í—˜ êµ¬ì—­ ì²´í¬
    p.updateDanger(dt);
    e.updateDanger(dt);

    // Player basic attack - ì¹¼ íœ˜ë‘ë¥´ê¸° ì‹œì‘
    p.basicCd-=dt;
    if(p.basicCd<=0&&(keys['Space']||mobileShoot)){
      // ì¹¼ íœ˜ë‘ë¥´ê¸° ì‹œì‘ (ì• ë‹ˆë©”ì´ì…˜ë§Œ)
      this.lastPlayerBasicT=now;
      p.basicCd=CFG.BASIC_CD;
      mobileShoot=false; // ëª¨ë°”ì¼ í„°ì¹˜ ì´ˆê¸°í™”
    }
    
    // ì¹¼ íœ˜ë‘ë¥´ëŠ” ë™ì•ˆ ì¶©ëŒ íŒì • (í”„ë ˆì„ë§ˆë‹¤ ì²´í¬)
    const SWING_TIME=250;
    if(this.lastPlayerBasicT && now-this.lastPlayerBasicT<SWING_TIME){
      const elapsed=now-this.lastPlayerBasicT;
      const progress=elapsed/SWING_TIME;
      
      // ì¹¼ì˜ ì‹¤ì œ ìœ„ì¹˜ ê³„ì‚°
      const dir=p.facing==='right'?1:-1;
      const armY=p.y+10-Math.sin(progress*Math.PI)*30;
      const weaponAngle=-Math.PI/2 + Math.PI*progress; // dir ê³±ì…ˆ ì œê±°
      const armX=p.x+28*dir;
      
      // ì¹¼ë‚  ë ìœ„ì¹˜ ê³„ì‚° (78px ê¸¸ì´ - 1.2ë°° ìŠ¤ì¼€ì¼)
      const swordLen=78;
      const swordTipX=armX+Math.cos(weaponAngle)*swordLen*dir;
      const swordTipY=armY+Math.sin(weaponAngle)*swordLen;
      
      // ì¹¼ ì¤‘ê°„ ìœ„ì¹˜
      const swordMidX=armX+Math.cos(weaponAngle)*40*dir;
      const swordMidY=armY+Math.sin(weaponAngle)*40;
      
      // ì  ì¶©ëŒ ì²´í¬
      if(dist({x:swordTipX,y:swordTipY},e)<35 || dist({x:swordMidX,y:swordMidY},e)<35){
        // í•œ ë²ˆë§Œ ë°ë¯¸ì§€ë¥¼ ì£¼ê¸° ìœ„í•œ ì²´í¬
        if(!this.swordHitEnemy){
          e.hp=Math.max(0,e.hp-CFG.BASIC_DMG);
          this.particles.push(new Particle(e.x,e.y,'#ef4444',10));
          this.swordHitEnemy=true;
        }
      }
      
      // ì  í¬ë¦¬ì²˜ ì¶©ëŒ ì²´í¬
      for(let j=e.creatures.length-1;j>=0;j--){
        const cr=e.creatures[j];
        if(dist({x:swordTipX,y:swordTipY},cr)<cr.size+20 || dist({x:swordMidX,y:swordMidY},cr)<cr.size+20){
          this.particles.push(new Particle(cr.x,cr.y,'#fbbf24',12));
          if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)e.creatures.splice(j,1);}
          else e.creatures.splice(j,1);
        }
      }
      
      // ì¹¼ íœ˜ë‘ë¥´ê¸° íŒŒí‹°í´ íš¨ê³¼
      if(Math.random()<0.4){
        this.particles.push(new Particle(swordTipX,swordTipY,'#93c5fd',3));
      }
    } else {
      // ì¹¼ íœ˜ë‘ë¥´ê¸° ëë‚˜ë©´ ì´ˆê¸°í™”
      this.swordHitEnemy=false;
    }
    
    // ë©€í‹°í”Œë ˆì´ ê³µê²© ì „ì†¡
    if(this.lastPlayerBasicT && now-this.lastPlayerBasicT<50 && this.isMulti){
      const dir=p.facing==='right'?1:-1;
      netSend({t:'mb',x:p.x+40*dir,y:p.y});
    }

    // AI
    if(this.ai) this.ai.tick(now,this.orbs,this.projectiles);

    // Orbs pickup
    for(let i=this.orbs.length-1;i>=0;i--){
      const o=this.orbs[i];o.update();
      if(dist(p,o)<22){
        p.mana=Math.min(CFG.MAX_MANA,p.mana+o.bonus);
        this.particles.push(new Particle(o.x,o.y,o.rich?'#fbbf24':'#a855f7',12));
        this.orbs.splice(i,1);
      } else if(dist(e,o)<22){
        e.mana=Math.min(CFG.MAX_MANA,e.mana+o.bonus);
        this.orbs.splice(i,1);
      }
    }

    // Projectile collision
    for(let i=this.projectiles.length-1;i>=0;i--){
      const pj=this.projectiles[i];pj.update();
      if(pj.dead){this.projectiles.splice(i,1);continue;}

      let hit=false;
      const hurtEnemy=(pj.owner==='player');
      const hurtPlayer=(pj.owner==='enemy');

      if(hurtEnemy){
        if(dist(pj,e)<32){
          e.hp=Math.max(0,e.hp-pj.dmg);
          this.particles.push(new Particle(pj.x,pj.y,pj.color,8));
          pj.dead=true;hit=true;
        } else {
          for(let j=e.creatures.length-1;j>=0&&!hit;j--){
            const cr=e.creatures[j];
            if(dist(pj,cr)<cr.size+pj.size){
              this.particles.push(new Particle(cr.x,cr.y,cr.color,10));
              if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)e.creatures.splice(j,1);}
              else e.creatures.splice(j,1);
              pj.dead=true;hit=true;
            }
          }
        }
      }
      if(!hit&&hurtPlayer){
        if(dist(pj,p)<32){
          p.hp=Math.max(0,p.hp-pj.dmg);
          this.particles.push(new Particle(pj.x,pj.y,pj.color,8));
          pj.dead=true;hit=true;
        } else {
          for(let j=p.creatures.length-1;j>=0&&!hit;j--){
            const cr=p.creatures[j];
            if(dist(pj,cr)<cr.size+pj.size){
              this.particles.push(new Particle(cr.x,cr.y,cr.color,10));
              if(cr.shield){cr.currentHp--;if(cr.currentHp<=0)p.creatures.splice(j,1);}
              else p.creatures.splice(j,1);
              pj.dead=true;hit=true;
            }
          }
        }
      }
      if(pj.dead) this.projectiles.splice(i,1);
    }

    // Creature movement
    e.creatures.forEach(c=>{
      const proj=c.update(p, p.creatures); // ì  í¬ë¦¬ì²˜ = í”Œë ˆì´ì–´ í¬ë¦¬ì²˜ë“¤
      if(proj) this.projectiles.push(proj);
      if(c.dead) this.particles.push(new Particle(c.x,c.y,'#facc15',14));
    });
    e.creatures=e.creatures.filter(c=>!c.dead);
    
    p.creatures.forEach(c=>{
      const proj=c.update(e, e.creatures); // ì  í¬ë¦¬ì²˜ = AI/ìƒëŒ€ í¬ë¦¬ì²˜ë“¤
      if(proj) this.projectiles.push(proj);
      if(c.dead) this.particles.push(new Particle(c.x,c.y,'#facc15',14));
    });
    p.creatures=p.creatures.filter(c=>!c.dead);

    // Particles
    this.particles.forEach(pt=>pt.update());
    this.particles=this.particles.filter(pt=>!pt.dead);

    this.updateHUD();

    // Win check
    if(this.state==='playing'&&(p.hp<=0||e.hp<=0)){
      const won=p.hp>0;
      if(won) this.playerWins++; else this.enemyWins++;
      this.state='roundOver';
      this._clearIvals();
      setTimeout(()=>this.showResult(won),400);
    }
  },

  _render(){
    const c=ctx;
    
    // Background
    const bg=c.createLinearGradient(0,0,CFG.W,CFG.H);
    bg.addColorStop(0,'#0d0b1a');bg.addColorStop(.5,'#14102a');bg.addColorStop(1,'#1a0f38');
    c.fillStyle=bg;c.fillRect(0,0,CFG.W,CFG.H);
    
    // Stars
    const T=Date.now();
    for(let i=0;i<60;i++){
      c.globalAlpha=(Math.sin(T*.0008+i)*.4+.6)*.4;c.fillStyle='#fff';
      c.fillRect((i*157+13)%CFG.W,(i*211+7)%CFG.H,(i%2)+1,(i%2)+1);
    }
    c.globalAlpha=1;
    
    // Center line
    c.strokeStyle='#a855f7';c.lineWidth=3;c.setLineDash([14,12]);
    c.shadowBlur=14;c.shadowColor='#a855f780';
    c.beginPath();c.moveTo(CFG.MID,0);c.lineTo(CFG.MID,CFG.H);c.stroke();
    c.setLineDash([]);c.shadowBlur=0;
    
    // Draw attack range effect when active - ì¹¼ íœ˜ë‘ë¥´ëŠ” ê¶¤ì 
    const SWING_TIME=250;
    if(this.lastPlayerBasicT && T-this.lastPlayerBasicT<SWING_TIME){
      const elapsed=Math.min(SWING_TIME,T-this.lastPlayerBasicT);
      const progress=elapsed/SWING_TIME;
      const alpha=(1-progress)*0.7;
      
      const p=this.player;
      const dir=p.facing==='right'?1:-1;
      const armY=p.y+10-Math.sin(progress*Math.PI)*30;
      const weaponAngle=-Math.PI/2 + Math.PI*progress; // dir ê³±ì…ˆ ì œê±°
      const armX=p.x+28*dir;
      
      // ì¹¼ ê¶¤ì  í‘œì‹œ - ë” ë‘ê»ê³  ì„ ëª…í•˜ê²Œ
      c.strokeStyle=`rgba(147,197,253,${alpha})`;
      c.lineWidth=14;
      c.shadowBlur=25;
      c.shadowColor=`rgba(147,197,253,${alpha*0.9})`;
      c.beginPath();
      const radius=65;
      const startAngle=-Math.PI/2;
      const endAngle=weaponAngle;
      // dirì— ë”°ë¼ ì¢Œìš° ë°˜ì „
      if(dir>0){
        c.arc(armX,armY,radius,startAngle,endAngle,false);
      } else {
        // ì™¼ìª½ ë°©í–¥ì¼ ë•ŒëŠ” xì¶• ëŒ€ì¹­
        c.save();
        c.translate(armX,armY);
        c.scale(-1,1);
        c.beginPath();
        c.arc(0,0,radius,startAngle,endAngle,false);
        c.stroke();
        c.restore();
        c.beginPath(); // ì´ë¯¸ ê·¸ë ¸ìœ¼ë‹ˆ ë‹¤ì‹œ ê·¸ë¦¬ì§€ ì•Šë„ë¡
      }
      if(dir>0) c.stroke();
      c.shadowBlur=0;
    }
    
    // Entities
    this.orbs.forEach(o=>o.draw(c));
    this.projectiles.forEach(pj=>pj.draw(c));
    
    // í¬ë¦¬ì²˜ ê·¸ë¦¬ê¸° (ë©€í‹°í”Œë ˆì´ ì‹œ remote í¬ë¦¬ì²˜ë„ í¬í•¨)
    this.player.creatures.forEach(cr=>cr.draw(c));
    if(this.enemy){
      this.enemy.creatures.forEach(cr=>cr.draw(c));
    }
    if(this.remote && this.remote !== this.enemy){
      this.remote.creatures.forEach(cr=>cr.draw(c));
    }
    
    this.particles.forEach(pt=>pt.draw(c));
    this.enemy.draw(c);
    this.player.draw(c);
  },

  updateHUD(){
    if(!this.player||!this.enemy) return;
    const p=this.player,e=this.enemy;
    const ph=Math.max(0,p.hp),eh=Math.max(0,e.hp);
    document.getElementById('p-hp').style.width=(ph/p.maxHp*100)+'%';
    document.getElementById('p-hp').className='hud-fill hp'+(ph/p.maxHp<.3?' low':'');
    document.getElementById('p-hp-v').textContent=Math.ceil(ph);
    document.getElementById('p-mp').style.width=(p.mana/p.maxMana*100)+'%';
    document.getElementById('p-mp-v').textContent=Math.floor(p.mana);
    document.getElementById('e-hp').style.width=(eh/e.maxHp*100)+'%';
    document.getElementById('e-hp-v').textContent=Math.ceil(eh);
    document.getElementById('e-mp').style.width=(e.mana/e.maxMana*100)+'%';
    document.getElementById('e-mp-v').textContent=Math.floor(e.mana);
    
    const now=performance.now();
    SPELL_DEFS.forEach((_,i)=>{
      const mobBtn=document.querySelector(`#mob-spell-grid .mob-skill-item[data-spell="${i}"]`);
      if(mobBtn) mobBtn.disabled=p.mana<SPELL_DEFS[i].cost;
    });
    CREATURE_DEFS.forEach((_,i)=>{
      const mobBtn=document.querySelector(`#mob-creature-grid .mob-skill-item[data-creature="${i}"]`);
      if(mobBtn) mobBtn.disabled=p.mana<CREATURE_DEFS[i].cost||p.creatures.length>=8;
    });
  },

  updateRoundHUD(){
    document.getElementById('round-info').textContent=`ROUND ${this.roundNum}`;
  },

  showResult(playerWon){
    const over=document.getElementById('overlayScreen');
    const title=document.getElementById('overlay-title');
    const sub=document.getElementById('overlay-sub');
    const next=document.getElementById('overlay-next');
    over.classList.remove('hidden');
    const gameOver=this.playerWins>=2||this.enemyWins>=2;
    if(gameOver){
      title.textContent=this.playerWins>=2?'ğŸ‰ ìµœì¢… ìŠ¹ë¦¬!':'ğŸ’€ ìµœì¢… íŒ¨ë°°';
      title.style.color=this.playerWins>=2?'#34d399':'#f87171';
      sub.textContent=`${this.playerWins} : ${this.enemyWins} â€” 3ì „ 2ì„ ìŠ¹`;
      next.textContent='ë‹¤ì‹œ í”Œë ˆì´';
      next.onclick=()=>{
        this.playerWins=0;this.enemyWins=0;this.roundNum=1;
        over.classList.add('hidden');this.startRound();
      };
    } else {
      title.textContent=playerWon?`ğŸ† ë¼ìš´ë“œ ${this.roundNum} ìŠ¹ë¦¬!`:`ğŸ’” ë¼ìš´ë“œ ${this.roundNum} íŒ¨ë°°`;
      title.style.color=playerWon?'#34d399':'#f87171';
      sub.textContent=`ì „ì  ${this.playerWins} : ${this.enemyWins}`;
      next.textContent='ë‹¤ìŒ ë¼ìš´ë“œ';this.roundNum++;
      next.onclick=()=>{over.classList.add('hidden');this.updateRoundHUD();this.startRound();};
    }
    document.getElementById('overlay-quit').onclick=()=>{
      this._clearIvals();
      this.playerWins=0;this.enemyWins=0;this.roundNum=1;
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('overlayScreen').classList.add('hidden');
      document.getElementById('menuScreen').classList.remove('hidden');
      this.state='menu';
    };
  },
};

// INIT
resizeCanvas();
document.getElementById('startSoloBtn').addEventListener('click',()=>{
  G.roundNum=1;G.playerWins=0;G.enemyWins=0;G.startRound();
});

// MULTIPLAYER
document.getElementById('showMultiBtn').addEventListener('click',()=>{
  const panel=document.getElementById('multiPanel');
  panel.style.display = panel.style.display==='none'?'block':'none';
});

let peer=null, conn=null, isHost=false, isMulti=false;

function makeCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:4},()=>chars[Math.floor(Math.random()*chars.length)]).join('');
}

function mkPeer(id){
  return new Promise((res,rej)=>{
    const p=new Peer(id,{
      config:{iceServers:[
        {urls:'stun:stun.l.google.com:19302'},
        {urls:'stun:stun1.l.google.com:19302'},
      ]},
    });
    p.on('open',()=>res(p));
    p.on('error',rej);
    setTimeout(()=>rej(new Error('ì—°ê²° íƒ€ì„ì•„ì›ƒ')),15000);
  });
}

function netSend(obj){
  if(conn&&conn.open){
    try{conn.send(JSON.stringify(obj));}
    catch(e){console.warn('send err',e);}
  }
}

function onData(raw){
  let d;
  try{d=(typeof raw==='string')?JSON.parse(raw):raw;}
  catch(e){return;}

  switch(d.t){
    case 's': // Full state sync
      if(!G.remote) return;
      G.remote.x=d.x; G.remote.y=d.y;
      G.remote.facing=d.f;
      G.remote.hp=d.hp;
      G.remote.mana=d.mn;
      
      // í¬ë¦¬ì²˜ ë™ê¸°í™”
      if(d.cr){
        // ê¸°ì¡´ í¬ë¦¬ì²˜ ì—…ë°ì´íŠ¸
        G.remote.creatures = d.cr.map(cData => {
          const def = CREATURE_DEFS.find(cd => cd.id === cData.i);
          if(!def) return null;
          const existing = G.remote.creatures.find(c => c.tempId === cData.tid);
          if(existing){
            existing.x = cData.x;
            existing.y = cData.y;
            existing.currentHp = cData.h;
            existing.dead = false;
            return existing;
          } else {
            const newCreature = new Creature(def, 'enemy', cData.x, cData.y);
            newCreature.tempId = cData.tid;
            newCreature.currentHp = cData.h;
            return newCreature;
          }
        }).filter(c => c !== null);
      }
      break;
    case 'p': // Projectile
      G.projectiles.push(new Projectile({
        x:d.x,y:d.y,vx:d.vx,vy:d.vy,
        dmg:d.dm,size:d.sz,color:d.cl,
        owner:G.remote?G.remote.side:'enemy',
      }));
      break;
    case 'mb': // Melee attack
      if(G.remote){
        G.particles.push(new Particle(d.x,d.y,'#93c5fd',8));
        G.lastEnemyBasicT=performance.now(); // ìƒëŒ€ë°© ê³µê²© ì• ë‹ˆë©”ì´ì…˜
        const MELEE_RANGE=60;
        if(dist(G.player,{x:d.x,y:d.y})<MELEE_RANGE){
          G.player.hp=Math.max(0,G.player.hp-CFG.BASIC_DMG);
          G.particles.push(new Particle(G.player.x,G.player.y,'#ef4444',10));
        }
      }
      break;
    case 'sp': // Spell cast
      if(d.i===1){ // Heal
        if(G.remote){
          G.remote.hp=d.hp;
          G.particles.push(new Particle(G.remote.x,G.remote.y,'#34d399',14));
        }
      }
      break;
    case 'cr': // Creature summon
      if(G.remote){
        const def = CREATURE_DEFS[d.i];
        if(def){
          const newCreature = new Creature(def, 'enemy', d.x, d.y);
          newCreature.tempId = d.tid;
          G.remote.creatures.push(newCreature);
        }
      }
      break;
  }
}

function setupConn(c){
  conn=c;
  conn.on('data',onData);
  conn.on('close',()=>{
    if(G.state==='playing'){
      alert('ìƒëŒ€ë°© ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.');
      location.reload();
    }
  });
  conn.on('error',err=>console.warn('conn err',err));
}

document.getElementById('createRoomBtn').addEventListener('click',async()=>{
  const code=makeCode();
  const btn=document.getElementById('createRoomBtn');
  btn.disabled=true;btn.textContent='ìƒì„± ì¤‘...';
  try{
    peer=await mkPeer('spellarena-'+code);
    isHost=true;
    document.getElementById('myRoomCode').style.display='block';
    document.getElementById('roomCodeDisplay').textContent=code;
    document.getElementById('hostStatus').textContent='ì¹œêµ¬ê°€ ì ‘ì†í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
    peer.on('connection',c=>{
      setupConn(c);
      document.getElementById('hostStatus').textContent='âœ… ì—°ê²°ë¨! ì ì‹œ í›„ ì‹œì‘...';
      setTimeout(()=>beginMulti(),1000);
    });
  }catch(err){
    document.getElementById('hostStatus').textContent='âŒ '+err.message;
    btn.disabled=false;btn.textContent='ë°© ìƒì„±í•˜ê¸°';
  }
});

document.getElementById('joinRoomBtn').addEventListener('click',async()=>{
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if(code.length!==4){
    document.getElementById('joinStatus').textContent='4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
    return;
  }
  const btn=document.getElementById('joinRoomBtn');
  btn.disabled=true;
  document.getElementById('joinStatus').textContent='ì—°ê²° ì¤‘...';
  try{
    peer=await mkPeer('spellarena-guest-'+Math.random().toString(36).slice(2,7));
    isHost=false;
    const c=peer.connect('spellarena-'+code,{
      reliable:true,
      serialization:'json',
    });
    c.on('open',()=>{
      setupConn(c);
      document.getElementById('joinStatus').textContent='âœ… ì—°ê²°ë¨! ì ì‹œ í›„ ì‹œì‘...';
      setTimeout(()=>beginMulti(),1000);
    });
    c.on('error',()=>{
      document.getElementById('joinStatus').textContent='âŒ ì—°ê²° ì‹¤íŒ¨';
      btn.disabled=false;
    });
    setTimeout(()=>{
      if(!c.open){
        document.getElementById('joinStatus').textContent='âŒ ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ';
        btn.disabled=false;
      }
    },8000);
  }catch(err){
    document.getElementById('joinStatus').textContent='âŒ '+err.message;
    btn.disabled=false;
  }
});

function beginMulti(){
  isMulti=true;
  G.isMulti=true;
  G.roundNum=1;G.playerWins=0;G.enemyWins=0;
  G.startRound();
}
</script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</body>
</html>
